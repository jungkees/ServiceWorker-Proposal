<!DOCTYPE html><html lang="en-US"><head>
    <meta charset="utf-8">
    <title>Service Workers</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <div class="head">

      <h1 id="serviceworker" class="head">[Unofficial draft] Service Workers</h1>
      <h2 class="dontpublish no-num no-toc" id="subtitle">Not maintained any more; Self-reference purpose only</h2>

      <!--dl>
        <dt>This version:</dt>
        <dd class=dontpublish><a href="http://w3c.github.io/serviceworker">http://w3c.github.io/serviceworker</a></dd>
        <dd class=publish><a href="http://www.w3.org/TR/2014/ED-serviceworker-20140122/">http://www.w3.org/TR/2014/ED-serviceworker-20140122/</a></dd>

        <dt class=dontpublish>Participate:</dt>
        <dd class=dontpublish>Send feedback to
        <a href="mailto:public-webapps@w3.org?subject=%ServiceWorker%5D%20">public-webapps@w3.org</a>
        (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>) or
        <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG&amp;component=ServiceWorker">file a bug</a>
        (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WebAppsWG&amp;component=ServiceWorker&amp;resolution=---">open bugs</a>)
        <dd class=dontpublish><a href="http://irc.w3.org">IRC: #webapps</a>

        <dt class=dontpublish>Version history:
        <dd class=dontpublish><a href="https://github.com/jungkees/ServiceWorker-Proposal/commits/gh-pages">https://github.com/jungkees/ServiceWorker-Proposal/commits/gh-pages</a>


        <dt class=publish>Latest version:</dt>
        <dd class=publish><a href="http://www.w3.org/TR/serviceworker/">http://www.w3.org/TR/serviceworker/</a></dd>

        <dt>Latest editor's draft:</dt>
        <dd><a href="http://w3c.github.io/serviceworker">http://w3c.github.io/serviceworker</a></dd>

        <dt class=publish>Previous versions:</dt>
        <dd class=publish><a href="http://w3c.github.io/serviceworker">http://w3c.github.io/serviceworker</a></dd>

        <dt>Editors:</dt>
        <dd><a href="http://infrequently.org/">Alex Russell</a>,
         <a href="http://www.google.com/">Google</a>
        </dd>
        <dd><a href="mailto:jungkee.song@samsung.com">Jungkee Song</a>,
         <a href="http://www.samsung.com/sec/">Samsung Electronics</a>
        </dd>

        <dt>Repository:</dt>
        <dd><a href="https://github.com/slightlyoff/ServiceWorker/">Github repository</a>
        </dd>
        <dd><a href="https://github.com/slightlyoff/ServiceWorker/issues/">File a bug</a>
        </dd>
        <dd><a href="https://github.com/jungkees/ServiceWorker-Proposal/commits/gh-pages">Commit history</a>
        </dd>
      </dl-->
    </div>


    <hr class="top">

    <div class="dontpublish"><!-- ED version -->
      <h2 class="no-num no-toc" id="specabstract">Abstract</h2>

      <p>This specification describes the method for web applications to enable background functionality, including hooks to enable bootstrapping of web applications while offline.</p>

      <h2 class="no-num no-toc" id="sotd">Status of this Document</h2>

      <!--p><em>This section describes the status of this document at the time of its
      publication. Other documents may supersede this document. A list of current
      W3C publications and the latest revision of this technical report can be
      found in the <a href="http://www.w3.org/TR/">W3C technical reports index</a>
      at http://www.w3.org/TR/.</em></p-->

      <p><strong>This is NOT an active document</strong>. <strong>Do NOT reference this document</strong>. See <a href="https://github.com/slightlyoff/ServiceWorker/tree/master/spec/">here</a> for the active document.</p>

      <!--p>If you wish to make comments regarding this document in a manner
      that is tracked by the W3C, please submit them via using <a href="http://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG">our public bug database</a>, or please send comments to
      <a href="mailto:public-webapps@w3.org?subject=%5BServiceWorker%5D%20">public-webapps@w3.org</a>
      (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archived</a>)
      with <samp>[ServiceWorker]</samp> at the start of the subject line.</p>

      <p>The W3C <a href="http://www.w3.org/2008/webapps/">Web Applications Working
      Group</a> is the W3C working group responsible for this specification's progress along the W3C Recommendation track. This specification is the 22 January 2014 Editor's Draft.</p>

      <p>Publication as an Editor's Draft does not imply endorsement by the W3C
      Membership. This is a draft document and may be updated, replaced or
      obsoleted by other documents at any time. It is inappropriate to cite this
      document as other than work in progress.</p>

      <p>This document was produced by a group operating under the
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004
      W3C Patent Policy</a>. W3C maintains a
      <a rel="disclosure" href="http://www.w3.org/2004/01/pp-impl/42538/status">public
      list of any patent disclosures</a> made in connection with the deliverables of
      the group; that page also includes instructions for disclosing a patent. An
      individual who has actual knowledge of a patent which the individual believes
      contains
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
      Claim(s)</a> must disclose the information in accordance with
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
      6 of the W3C Patent Policy</a>.</p>
    </div-->

    <!--div class=publish><!-- publication version -->
      <!--h2 class="no-num no-toc" id="specabstract">Abstract</h2>

      <p>This specification describes the method for web applications to enable background functionality, including hooks to enable bootstrapping of web applications while offline.</p>

      <h2 class="no-num no-toc" id="sotd">Status of this Document</h2>

      <p><em>This section describes the status of this document at the time of its
      publication. Other documents may supersede this document. A list of current
      W3C publications and the latest revision of this technical report can be
      found in the <a href="http://www.w3.org/TR/">W3C technical reports index</a>
      at http://www.w3.org/TR/.</em></p>

      <p>If you wish to make comments regarding this document in a manner
      that is tracked by the W3C, please submit them via using <a href="http://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG">our public bug database</a>, or please send comments to
      <a href="mailto:public-webapps@w3.org?subject=%5BServiceWorker%5D%20">public-webapps@w3.org</a>
      (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archived</a>)
      with <samp>[ServiceWorker]</samp> at the start of the subject line.</p>

      <p>The W3C <a href="http://www.w3.org/2008/webapps/">Web Applications Working
      Group</a> is the W3C working group responsible for this specification's progress along the W3C Recommendation track. This specification is the 22 January 2014 Working Draft.</p>

      <p>Publication as a Working Draft does not imply endorsement by the W3C
      Membership. This is a draft document and may be updated, replaced or
      obsoleted by other documents at any time. It is inappropriate to cite this
      document as other than work in progress.</p>

      <p>This document was produced by a group operating under the
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004
      W3C Patent Policy</a>. W3C maintains a
      <a rel="disclosure" href="http://www.w3.org/2004/01/pp-impl/42538/status">public
      list of any patent disclosures</a> made in connection with the deliverables of
      the group; that page also includes instructions for disclosing a patent. An
      individual who has actual knowledge of a patent which the individual believes
      contains
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
      Claim(s)</a> must disclose the information in accordance with
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
      6 of the W3C Patent Policy</a>.</p>
    </div-->

    <h2 class="no-num no-toc" id="toc">Table of Contents</h2>
    
<!--begin-toc-->
<ol class="toc">
 <li><a href="#introduction"><span class="secno">1 </span>Introduction</a>
  <ol class="toc">
   <li><a href="#motivations"><span class="secno">1.1 </span>Offline-first web applications: the motivations</a></li>
   <li><a href="#lack-of-the-controllability-with-the-existing-solution:-appcache"><span class="secno">1.2 </span>Lack of the controllability with the existing solution: AppCache</a></li>
   <li><a href="#service-workers"><span class="secno">1.3 </span>Service workers</a></ol></li>
 <li><a href="#conformance"><span class="secno">2 </span>Conformance</a>
  <ol class="toc">
   <li><a href="#dependencies"><span class="secno">2.1 </span>Dependencies</a></li>
   <li><a href="#extensibility"><span class="secno">2.2 </span>Extensibility</a></ol></li>
 <li><a href="#terminology"><span class="secno">3 </span>Terminology</a></li>
 <li><a href="#interfaces"><span class="secno">4 </span>Interfaces</a>
  <ol class="toc">
   <li><a href="#extensions-to-the-navigator-object"><span class="secno">4.1 </span>Extensions to the <code>Navigator</code> object</a></li>
   <li><a href="#the-serviceworker-interface"><span class="secno">4.2 </span>The <code>ServiceWorker</code> interface</a></li>
   <li><a href="#the-serviceworkerglobalscope-interface"><span class="secno">4.3 </span>The <code>ServiceWorkerGlobalScope</code> interface</a></li>
   <li><a href="#the-reloadpageevent-interface"><span class="secno">4.4 </span>The <code>ReloadPageEvent</code> interface</a></li>
   <li><a href="#the-installevent-interface"><span class="secno">4.5 </span>The <code>InstallEvent</code> interface</a></li>
   <li><a href="#the-installphaseevent-interface"><span class="secno">4.6 </span>The <code>InstallPhaseEvent</code> interface</a></li>
   <li><a href="#the-fetchevent-interface"><span class="secno">4.7 </span>The <code>FetchEvent</code> interface</a></li>
   <li><a href="#the-beforecacheevictionevent-interface"><span class="secno">4.8 </span>The <code>BeforeCacheEvictionEvent</code> interface</a></li>
   <li><a href="#the-cacheevictionevent-interface"><span class="secno">4.9 </span>The <code>CacheEvictionEvent</code> interface</a></li>
   <li><a href="#the-request-interface"><span class="secno">4.10 </span>The <code>Request</code> interface</a></li>
   <li><a href="#the-response-interface"><span class="secno">4.11 </span>The <code>Response</code> interface</a></li>
   <li><a href="#the-sameoriginresponse-interface"><span class="secno">4.12 </span>The <code>SameOriginResponse</code> interface</a></li>
   <li><a href="#the-crossoriginresponse-interface"><span class="secno">4.13 </span>The <code>CrossOriginResponse</code> interface</a></li>
   <li><a href="#the-cache-interface"><span class="secno">4.14 </span>The <code>Cache</code> interface</a></li>
   <li><a href="#the-cachelist-interface"><span class="secno">4.15 </span>The <code>CacheList</code> interface</a></li>
   <li><a href="#events"><span class="secno">4.16 </span>Events summary</a></ol></li>
 <li><a href="#bootstrap-with-a-service-worker"><span class="secno">5 </span>Bootstrap with a service worker</a>
  <ol class="toc">
   <li><a href="#the-registerserviceworker()-method"><span class="secno">5.1 </span>The <span title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></span> method</a></li>
   <li><a href="#the-member-service_worker-of-the-manifest"><span class="secno">5.2 </span>The member <em><code>service_worker</code></em> of the manifest</a></li>
   <li><a href="#controlled-and-uncontrolled-documents"><span class="secno">5.3 </span><em>Controlled</em> and <em>uncontrolled</em> documents</a></li>
   <li><a href="#longest-prefix-matching"><span class="secno">5.4 </span>Longest-prefix matching</a></li>
   <li><a href="#last-registration-wins"><span class="secno">5.5 </span>Last-registration wins</a></li>
   <li><a href="#cross-origin-limitation"><span class="secno">5.6 </span>Cross-origin limitation</a></ol></li>
 <li><a href="#lifecycle-of-a-service-worker"><span class="secno">6 </span>Lifecycle of a service worker</a></li>
 <li><a href="#upgrade-with-a-new-version"><span class="secno">7 </span>Upgrade with a new version</a>
  <ol class="toc">
   <li><a href="#wait-for-restart"><span class="secno">7.1 </span>Wait-for-restart</a></li>
   <li><a href="#replacement"><span class="secno">7.2 </span>Replacement</a></ol></li>
 <li><a href="#offline-first-resource-handling"><span class="secno">8 </span>Offline-first resource handling</a>
  <ol class="toc">
   <li><a href="#fetchevent-handling"><span class="secno">8.1 </span><code>FetchEvent</code> handling</a></li>
   <li><a href="#navigation-vs-fetch"><span class="secno">8.2 </span>Navigation vs Fetch</a></li>
   <li><a href="#fallback-rule"><span class="secno">8.3 </span>Fallback rule</a></li>
   <li><a href="#redirects"><span class="secno">8.4 </span>Redirects</a></li>
   <li><a href="#cross-origin-resources"><span class="secno">8.5 </span>Cross-origin resources</a></ol></li>
 <li><a href="#caching"><span class="secno">9 </span>Caching</a>
  <ol class="toc">
   <li><a href="#ready-with-populated-cache-object"><span class="secno">9.1 </span>Ready with populated cache object</a></li>
   <li><a href="#serving-cached-resources"><span class="secno">9.2 </span>Serving Cached Resources</a></ol></li>
 <li><a href="#extensions"><span class="secno">10 </span>Extensions</a></li>
 <li><a href="#references" class="no-num">References</a></li>
 <li><a href="#acknowledgments" class="no-num">Acknowledgments</a></ol>
<!--end-toc-->

    <h2 id="introduction"><span class="secno">1 </span>Introduction</h2>
    <p><em>This section is non-normative.</em></p>

    <h3 id="motivations"><span class="secno">1.1 </span>Offline-first web applications: the motivations</h3>
    <p>Web applications are traditionally premised on the assumption that the network is reachable. This assumption pervades the platform. <a href="#refsHTML">[HTML]</a> documents are loaded over HTTP and traditionally <a title="fetch" href="http://fetch.spec.whatwg.org/#concept-fetch" class="external">fetch</a> all of their sub-resources via subsequent <a href="#refsHTTP">[HTTP]</a> requests. This places web content at a disadvantage versus other technology stacks.</p>

    <h3 id="lack-of-the-controllability-with-the-existing-solution:-appcache"><span class="secno">1.2 </span>Lack of the controllability with the existing solution: AppCache</h3>
    <p>AppCache is declarative. Web developers give the browser a manifest and magic happens. This has well-known limitations that the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s work around by giving developers the lower-level primitives that AppCache is described in terms of.</p>

    <h3 id="service-workers"><span class="secno">1.3 </span>Service workers</h3>
    <p><dfn title="concept-serviceworker" id="concept-serviceworker">Service worker</dfn>s are a new feature for the web platform that lets a script persistently cache resources and handle all resource requests for an application even when the network is not available. <a title="concept-serviceworker" href="#concept-serviceworker">Service worker</a>s are bit of scripts that can listen for network events (such as resource requests), manage content caches, and thus decide what content to display when a URL is requested. <a href="#refsURL">[URL]</a> Putting it all together, <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s give you a way to build applications that work offline.</p>

    <div class="example">
      <p>Some simple code to install a service worker:</p>

      <pre title="Installation from a page">// Document hosted at: http://videos.example.com/index.html
navigator.registerServiceWorker("/*", "/assets/v1/worker.js").then(
  function(serviceWorker) {
    serviceWorker.postMessage("Howdy from your installing page.");
    // To use the serviceWorker immediately, you might call window.location.reload()
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });</pre>

      <p>Populate cache and serve fetch events from the worker script:</p>
      <pre title="ServiceWorker script">// Service worker script hosted at: http://videos.example.com/assets/v1/worker.js
this.version = 1;

this.addEventListener("install", function(e) {
  // Create a cache of resources. Begins the process of fetching them.
  var shellResources = new Cache(
    "/app.html",
    "/assets/v1/base.css",
    "/assets/v1/app.js",
    "/assets/v1/logo.png",
    "/assets/v1/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  caches.set("shell-v1", shellResources);

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());
});

this.addEventListener("fetch", function(e) {
  // No "onfetch" events are dispatched to the ServiceWorker until it
  // successfully installs.

  // All operations on caches are async, including matching URLs, so we use
  // Promises heavily. e.respondWith() even takes Promises to enable this:
  e.respondWith(caches.match("shell-v1", e.request.url));
});</pre>
    </div>

    <h2 id="conformance"><span class="secno">2 </span>Conformance</h2>

    <p>All diagrams, examples, and notes in this specification are
    non-normative, as are all sections explicitly marked non-normative.
    Everything else in this specification is normative.</p>

    <p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
    NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
    "OPTIONAL" in the normative parts of this specification are to be
    interpreted as described in RFC2119. For readability, these words do
    not appear in all uppercase letters in this specification.
    <a href="#refsRFC2119">[RFC2119]</a></p>

    <h3 id="dependencies"><span class="secno">2.1 </span>Dependencies</h3>
    <p>This specification relies on several underlying specifications.</p>

    <ul>
      <li><p>DOM Living Standard <a href="#refsDOM">[DOM]</a></li>
      <li><p>HTML Living Standard <a href="#refsHTML">[HTML]</a></li>
      <li><p>ECMAScript Langauage Specification <a href="#refsECMASCRIPT">[ECMASCRIPT]</a></li>
      <li><p>Web IDL <a href="#refsWEBIDL">[WEBIDL]</a></li>
    </ul>
    <p>It uses the typographic conventions from HTML. <a href="#refsHTML">[HTML]</a></p>

    <h3 id="extensibility"><span class="secno">2.2 </span>Extensibility</h3>

    <p>User agents, Working Groups, and other interested parties are
    <em>strongly encouraged</em> to discuss new features on a relevant public
    forum, preferably
    <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>. If this
    is for some reason not possible prefix the extension in some way. E.g. if
    company Foo wants to add a proprietary method <code>bar()</code> it could
    be named <code>fooBar()</code> to prevent clashes with a potential
    non-proprietary method <code>bar()</code>.</p>

    <h2 id="terminology"><span class="secno">3 </span>Terminology</h2>

    <p>The <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> interface provides asynchronous access to the result of an operation that is ongoing, has yet to start, or has completed, as defined in <a href="#refsDOM">[DOM]</a>.</p>

    <h2 id="interfaces"><span class="secno">4 </span>Interfaces</h2>
    <p class="note">This section normatively specifies the interfaces and the algorithms for the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> infrastructure and lifecycle management. Relevant explainer is followed on the subsequent sections: Bootstrapping, Upgrade, <code><a href="#fetchevent">FetchEvent</a></code> and Caching.</p>

    <h3 id="extensions-to-the-navigator-object"><span class="secno">4.1 </span>Extensions to the <code>Navigator</code> object</h3>
    <pre class="idl">partial interface <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#navigator-0" class="external">Navigator</a> {
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <a title="serviceworker-navigator-registerserviceworker" href="#serviceworker-navigator-registerserviceworker">registerServiceWorker</a>(DOMString <var>scope</var>, DOMString <var>scriptURL</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <span title="">unregisterServiceWorker</span>(<a href="#serviceworker-0">ServiceWorker</a> <var><a href="#serviceworker-0">serviceWorker</a></var>);
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onserviceworkerinstall</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onserviceworkerreplaced</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onserviceworkerreloadpage</span>;
};</pre>

    <p>When the <dfn title="serviceworker-navigator-registerserviceworker" id="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker(scope, scriptURL)</code></dfn> method is invoked, the user agent must run the following steps:</p>

    <ol>
      <li><p>Let <var>promise</var> be a newly-created <code><a href="http://w3c.github.io/dom/#promises" class="external">Promise</a></code> object.</li>
      <li><p>Return <var>promise</var> and run the remaining steps asynchronously.</li>
      <li><p>If the request violates a policy decision (e.g. if the user agent is configured to not allow the page to start service workers), run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception" class="external">DOMException</a> object whose type is "<a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#securityerror" class="external">SecurityError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      </li>
      <li><p><a title="resolve a url" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#resolve-a-url" class="external">Resolve</a> the <var>scriptURL</var> argument.</li>
      <li><p>If this fails, run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception" class="external">DOMException</a> object whose type is "<a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#syntaxerror" class="external">SyntaxError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      </li>
      <li><p>Let <var>scriptURL</var> be the resulting <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#absolute-url" class="external">absolute URL</a> and <var>parsed scriptURL</var> be the resulting <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#parsed-url" class="external">parsed URL</a>.</li>
      <li><p>If the <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#scheme" class="external">scheme</a> component of <var>parsed scriptURL</var> is not "<code>data</code>", and the <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#origin" class="external">origin</a> of <var>scriptURL</var> is not the <a title="same origin" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#same-origin" class="external">same</a> as the <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#origin" class="external">origin</a> specified by the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object" class="external">incumbent settings object</a>, run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception" class="external">DOMException</a> object whose type is "<a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#securityerror" class="external">SecurityError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      <p class="note">Thus, scripts must either be external files with the same scheme, host, and port as the original page, or <a title="data protocol" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#data:-url" class="external"><code>data:</code> URLs</a>. For example, and an <code>https:</code> page couldn't start workers using scripts with http: URLs.</li>
      <li><p>Let <var>docs</var> be the <a title="list of relevant document objects to add" href="http://dev.w3.org/html5/workers/#list-of-relevant-document-objects-to-add" class="external">list of relevant <code>Document</code> objects to add</a> given the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object" class="external">incumbent settings object</a>.</li>
      <li><p>Execute the following substeps atomically:</p>
        <ol>
          <li><p>Create a new <a href="#serviceworker-0">ServiceWorker</a> object, which will shortly be associated with a <a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a> object. Let this <a href="#serviceworker-0">ServiceWorker</a> object be <var>worker</var>.</li>
          <li><p>Create a new <a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a> object whose owner is the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object" class="external">incumbent settings object</a>. Let this be the <var>outside port</var>.</li>
          <li><p>Associate the <var>outside port</var> with <var>worker</var>.</li>
          <li><p>Let <var>worker global scope</var> be null.</li>
          <li><p>Create a new <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object. Let <var>worker global scope</var> be this new object.</p>
            <p class="critical">When there exists another active service worker which covers exactly the same <code><span>scope</span></code>, a new service worker is to be created by this algorithm. As the newly created worker would be effective from the next page load, that currently effective worker should not be terminated right away. An algorithm to sweep the unbound service workers should be added. Sweeping must not be conducted unless otherwise the list of <a title="the-worker-s-documents" href="http://dev.w3.org/html5/workers/#the-worker-s-documents" class="external">the worker's <code><span>Document</span></code>s</a> is empty. (See <a href="#last-registration-wins">Last-registration wins</a>.)</p>
          </li>
          <li><p><a href="http://dev.w3.org/html5/workers/#set-up-a-worker-script-settings-object" class="external">Set up a worker script settings object</a> with <var>worker global scope</var> and <var>scriptURL</var>, and let <var>settings object</var> be the result.</li>
          <li><p>Associate <var>worker</var> with <var>worker global scope</var>.</li>
          <li><p>Set the <code><span>registration</span></code> attribute of <var>worker global scope</var> to <var>scope</var>.</li>
          <li><p>Create a new <code><a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a></code> object whose <a href="http://dev.w3.org/html5/postmsg/#concept-port-owner" class="external">owner</a> is <var>settings object</var>. Let <var>inside port</var> be this new object.</li>
          <li><p><a href="http://dev.w3.org/html5/postmsg/#entangle" class="external">Entangle</a> <var>outside port</var> and <var>inside port</var>.</li>
        </ol>
      </li>
      <li><p>Let <var title="">serviceWorker</var> be <var>worker</var>.</li>
      <li><p>Resolve <var>promise</var> with <var title="">serviceWorker</var> and perform the remaining steps asynchronously.</li>
      <li><p>Create a <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#trusted-event" class="external">trusted event</a> that uses the <code><a href="#installevent"><span>InstallEvent</span></a></code> interface, with the name <code>install</code>, which does not bubble, is not cancelable, has no default action, has a <code>previous</code> attribute whose value is initialized to null, and <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#queue-a-task" class="external">queue a task</a> to <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#dispatching" class="external">dispatch</a> the event at <var>worker global scope</var>.</li>
      <li><p><a title="add-a-document-to-the-worker-s-documents" href="http://dev.w3.org/html5/workers/#add-a-document-to-the-worker-s-documents" class="external">Add to <var>worker global scope</var>'s list of the worker's <code>Document</code>s</a> the <code><a href="http://www.w3.org/html/wg/drafts/html/master/dom.html#document" class="external">Document</a></code> objects in <var>docs</var>.</li>
      <li><p>If the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object" class="external">global object</a> specified by the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object" class="external">incumbent settings object</a> is a <code><a href="http://dev.w3.org/html5/workers/#workerglobalscope" class="external">WorkerGlobalScope</a></code> object, add <var>worker global scope</var> to the list of <a title="the-worker-s-workers" href="http://dev.w3.org/html5/workers/#the-worker-s-workers" class="external">the worker's workers</a> of the <code><a href="http://dev.w3.org/html5/workers/#workerglobalscope" class="external">WorkerGlobalScope</a></code> object that is the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object" class="external">global object</a> specified by the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object" class="external">incumbent settings object</a> .</li>
      <li><p><a href="http://dev.w3.org/html5/workers/#run-a-worker" class="external">Run a worker</a> for the script with <a href="http://url.spec.whatwg.org/#url" class="external">URL</a> <var>scriptURL</var> and the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#script-settings-object" class="external">script settings object</a> <var>settings object</var>.</li>
    </ol>
    <p>The <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#task-source" class="external">task source</a> for the tasks mentioned above is the <a title="dom-manipulation-task-source" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#dom-manipulation-task-source" class="external">DOM manipulation task source</a>.</p>

    <p>The following are the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handlers</a> (and their corresponding <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a>s) that must be supported, as <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute" class="external">event handler IDL attribute</a>s, by objects implementing the extended <code><span>Navigator</span></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a title="event handlers" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handler</a></th>
          <th><a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn title="handler-serviceworker-onserviceworkerinstall" id="handler-serviceworker-onserviceworkerinstall"><code>onserviceworkerinstall</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerinstall"><a href="#event-serviceworker-serviceworkerinstall">serviceworkerinstall</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onserviceworkerreplaced" id="handler-serviceworker-onserviceworkerreplaced"><code>onserviceworkerreplaced</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerreplaced"><a href="#event-serviceworker-serviceworkerreplaced">serviceworkerreplaced</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onserviceworkerreloadpage" id="handler-serviceworker-onserviceworkerreloadpage"><code>onserviceworkerreloadpage</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerreloadpage"><a href="#event-serviceworker-serviceworkerreloadpage">serviceworkerreloadpage</a></code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-serviceworker-interface"><span class="secno">4.2 </span>The <code><a href="#serviceworker-0">ServiceWorker</a></code> interface</h3>
    <pre class="idl">[NoInterfaceObject]
interface <dfn id="serviceworker-0">ServiceWorker</dfn> : <a href="http://w3c.github.io/dom/#eventtarget" class="external">EventTarget</a> {
  void <span title="">postMessage</span>(any <var>message</var>, optional sequence&lt;Transferable&gt; <var>transfer</var>);
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onmessage</span>;
};
<a href="#serviceworker-0">ServiceWorker</a> implements <a title="abstractworker" href="http://dev.w3.org/html5/workers/#abstractworker" class="external">AbstractWorker</a>;</pre>

    <p><code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> objects act as if they had an implicit <a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a> associated with them. This port is part of a channel that is set up when the worker is registered, but it is not exposed. It represents the <a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a> for communicating with the service worker. This object must never be garbage collected before the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> object.</p>

    <p>All messages received by that port must immediately be retargeted at the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> object.</p>

    <p>The <code>postMessage()</code> method on <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> objects must act as if, when invoked, it immediately invoked <a title="dom-messageport-postmessage" href="http://dev.w3.org/html5/postmsg/#dom-messageport-postmessage" class="external">the method of the same name</a> on the port, with the same arguments, and returned the same return value.</p>

    <p>The following are the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handlers</a> (and their corresponding <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a>s) that must be supported, as <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute" class="external">event handler IDL attribute</a>s, by objects implementing the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a title="event handlers" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handler</a></th>
          <th><a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn title="handler-serviceworker-onmessage" id="handler-serviceworker-onmessage"><code>onmessage</code></dfn></td>
          <td><code title="event-serviceworker-message">message</code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-serviceworkerglobalscope-interface"><span class="secno">4.3 </span>The <code><a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a></code> interface</h3>
    <pre class="idl">[Global]
interface <dfn id="serviceworkerglobalscope">ServiceWorkerGlobalScope</dfn> : <a href="http://dev.w3.org/html5/workers/#workerglobalscope" class="external">WorkerGlobalScope</a> {
  getter <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy" class="external">WindowProxy</a>[] windows();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <span title="">fetch</span>((<a href="#request">Request</a> or <a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or DOMString or any) <var><a href="#request">request</a></var>);
  void <span title="">postMessage</span>(any <var>message</var>, optional sequence&lt;Transferable&gt; <var>transfer</var>);
  [Unforgeable] readonly attribute DOMString registration;
          attribute <a href="#cachelist">CacheList</a> caches;
          attribute any version;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>oninstall</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onactivate</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onfetch</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onbeforeevicted</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onevicted</span>;
          attribute <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler" class="external">EventHandler</a> <span>onmessage</span>;
  // close() method inherited from WorkerGlobalScope is not exposed.
};</pre>

    <p>The <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> interface must only be <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#exposed-to-javascript" class="external">exposed to JavaScript</a> if the <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#javascript-global-environment" class="external">JavaScript global environment</a> is a <span>service worker environment</span>.</p>

    <p class="note">Todo: the definition of the <span>service worker environment</span> should be placed in the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#processing-model-3" class="external">processing model</a> section of HTML specification.</p>

    <p><code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> objects act as if they had an implicit <a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a> associated with them. This port is part of a channel that is set up when the worker is created, but it is not exposed. This object must never be garbage collected before the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object.</p>

    <p>All messages received by that port must immediately be retargeted at the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object.</p>

    <p>Each <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object also has a <dfn id="event-ready">event ready</dfn> flag, which must initially be false, but which can get set to true by the algorithms in the <code><a href="#installphaseevent"><span>InstallPhaseEvent</span></a></code> interface section below.</p>

    <dl class="domintro">
      <dt><code><var>this</var>.windows</code></dt>
      <dd>Returns the array of the the <code><a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#window" class="external">Window</a></code> object's <code><a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#browsing-context" class="external">browsing context</a></code>'s <code><a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy" class="external">WindowProxy</a></code> object that the <a href="#serviceworkerglobalscope"><code>ServiceWorkerGlobalScope</code></a> is bound to.</dd>
      <dt><code><var>this</var>.fetch()</code></dt>
      <dd>Returns the <code>Promise</code> object that represents the <code><a href="#response">Response</a></code> object of the <a href="http://fetch.spec.whatwg.org/#concept-fetch" class="external">fetch</a>ed resource.</dd>
      <dt><code><var>this</var>.registration</code></dt>
      <dd>Returns the registration pattern that matched this service worker instance.</dd>
      <dt><code><var>this</var>.caches</code></dt>
      <dd>Returns the current <code><a href="#cachelist">CacheList</a></code> object.</dd>
      <dt><code><var>this</var>.version</code></dt>
      <dd>Returns the version that has been set by the worker. It is <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#structured-clone" class="external">structured clone</a>able.</dd>
    </dl>

    <p class="note">The <code>version</code> attribute is used to communicate to newer versions what they are replaceing (see the <code>previousVersion</code> attribute of the <code><a href="#installevent">InstallEvent</a></code> interface.)</p>

    <p>The following are the <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handlers</a> (and their corresponding <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a>s) that must be supported, as <a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute" class="external">event handler IDL attribute</a>s, by objects implementing the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a title="event handlers" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" class="external">event handler</a></th>
          <th><a href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type" class="external">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn title="handler-serviceworker-oninstall" id="handler-serviceworker-oninstall"><code>oninstall</code></dfn></td>
          <td><code title="event-serviceworker-install"><a href="#event-serviceworker-install">install</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onactivate" id="handler-serviceworker-onactivate"><code>onactivate</code></dfn></td>
          <td><code title="event-serviceworker-activate"><a href="#event-serviceworker-activate">activate</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onfetch" id="handler-serviceworker-onfetch"><code>onfetch</code></dfn></td>
          <td><code title="event-serviceworker-fetch"><a href="#event-serviceworker-fetch">fetch</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onbeforeevicted" id="handler-serviceworker-onbeforeevicted"><code>onbeforeevicted</code></dfn></td>
          <td><code title="event-serviceworker-beforeevicted"><a href="#event-serviceworker-beforeevicted">beforeevicted</a></code></td>
        </tr>
        <tr>
          <td><dfn title="handler-serviceworker-onevicted" id="handler-serviceworker-onevicted"><code>onevicted</code></dfn></td>
          <td><code title="event-serviceworker-evicted"><a href="#event-serviceworker-evicted">evicted</a></code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-reloadpageevent-interface"><span class="secno">4.4 </span>The <code><a href="#reloadpageevent">ReloadPageEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="reloadpageevent">ReloadPageEvent</dfn> : <a href="http://w3c.github.io/dom/#event" class="external">Event</a> {
  void <span>waitUntil</span>(<a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> f);
};</pre>

    <h3 id="the-installevent-interface"><span class="secno">4.5 </span>The <code><a href="#installevent">InstallEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="installevent">InstallEvent</dfn> : <a href="#installphaseevent">InstallPhaseEvent</a> {
  void <span>replace</span>();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <span>reloadAll</span>();
          attribute <a href="http://dev.w3.org/html5/postmsg/#messageport" class="external">MessagePort</a> previous;
};</pre>

    <dl class="domintro">
      <dt><code><var>event</var>.replace()</code></dt>
      <dd>Ensures that the worker is used in place of existing workers for the currently controlled set of window instances.</dd>
    </dl>

    <h3 id="the-installphaseevent-interface"><span class="secno">4.6 </span>The <code><a href="#installphaseevent">InstallPhaseEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="installphaseevent">InstallPhaseEvent</dfn> : <a href="http://w3c.github.io/dom/#event" class="external">Event</a> {
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <span>waitUntil</span>(<a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <var>f</var>);
          attribute any previousVersion;
};</pre>

    <dl class="domintro">
      <dt><code><var>event</var>.waitUntil(<var>f</var>)</code></dt>
      <dd>Delays treating the installing worker until the argument <var>f</var> resolves successfully. This is primarily used to ensure that a service worker is not active until all of the "core" <code><a href="#cache">Cache</a></code>s it depends on are populated. It returns a newly-created <code><a href="http://w3c.github.io/dom/#promises" class="external">Promise</a></code> object.</dd>
      <dt><code><var>event</var>.previousVersion</code></dt>
      <dd>Returns the version that had been set by the last execution of the previous worker. It is <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#structured-clone" class="external">structured clone</a>able. It can be used to set certain criteria of the replacement of the workers. (see the <a href="#replacement">replacement</a> section.)</dd>
    </dl>

    <p>The <code>waitUntil(<var>f</var>)</code> method must run these steps:</p>
    <ol>
      <li><p>Let <var>promise</var> be a newly-created <code><a href="http://w3c.github.io/dom/#promises" class="external">Promise</a></code> object.</li>
      <li><p>Return <var>promise</var> and run the remaining steps asynchronously.</li>
      <li><p>If <var>f</var> is not a thenable, run these substeps and abort these steps:</p>
        <ol>
          <li>Let <var>error</var> be a new <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception" class="external">DOMException</a> object whose type is "<a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#syntaxerror" class="external">SyntaxError</a>".<p></li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      </li>
      <li>
        <p>If <var>f</var> is fulfilled, set the worker's <a href="#serviceworkerglobalscope"><code>ServiceWorkerGlobalScope</code></a> object's <a href="#event-ready">event ready</a> flag to true and transform <var>f</var> with the success callback, if given.</p>
        <p>Otherwise, transform <var>f</var> with the failure callback, if given.</p>
        <p class="critical">The <a href="#event-ready">event ready</a> flag is to be used in the algorithms defined in the <code><a href="#fetchevent">FetchEvent</a></code> interface and other event interfaces added in the future. If an <code>install</code> event is fired but the <a href="#event-ready">event ready</a> flag is unset, the fetch event (more to be added e.g. push, alarm) must not be fired on the worker's <a href="#serviceworkerglobalscope"><code>ServiceWorkerGlobalScope</code></a> object. If this is an error situation and the worker remains idle, the worker may be sweeped by the system.</p>
      </li>
    </ol>

    <h3 id="the-fetchevent-interface"><span class="secno">4.7 </span>The <code><a href="#fetchevent">FetchEvent</a></code> interface</h3>
    <pre class="idl">[Constructor]
interface <dfn id="fetchevent">FetchEvent</dfn> : <a href="http://w3c.github.io/dom/#event" class="external">Event</a> {
  void <span>respondWith</span>((<a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> or <a href="#response">Response</a>) <var>r</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> <span>forwardTo</span>((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString) <var>url</var>);
  readonly attribute <a href="#request">Request</a> request;
  readonly attribute <a href="#requesttype">RequestType</a> type;
  readonly attribute <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy" class="external">WindowProxy</a> window;
  readonly attribute boolean isTopLevel;
  readonly attribute boolean isReload;
};

enum <dfn id="requesttype">RequestType</dfn> {
    "navigate",
    "fetch"
};</pre>

    <p>When a request is generated from a controlled document, user agent creates a <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#trusted-event" class="external">trusted event</a> that uses the <code><a href="#fetchevent"><span>FetchEvent</span></a></code> interface, with the name <code>fetch</code>, which does not bubble, is not cancelable, has no default action, has a <code><a href="#request"><span>request</span></a></code> attribute whose value is initialized to the <code><a href="#request"><span>Request</span></a></code> interface's instance object representing this request, has a <code><span>type</span></code> attribute whose value is initialized to a read only enum value "navigate" if the request is a <a title="navigated" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#navigated" class="external">navigation</a> or "fetch" otherwise, has a <code><span>window</span></code> attribute whose value is initialized to the document's <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#browsing-context" class="external">browsing context</a>'s <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy" class="external">WindowProxy</a> object, has a <code><span>isTopLevel</span></code> attribute whose value is initialized to true if the document's <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#browsing-context" class="external">browsing context</a> is a <a href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#top-level-browsing-context" class="external">top-level browsing context</a> or false otherwise, and has a <code><span>isReload</span></code> attribute whose value is initialized to true if the request comes from a document that has been soft reloaded or false otherwise, and queue a task to <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#dispatching" class="external">dispatch</a> the event at worker global scope.</p>
    <p class="note">The soft reloaded of a document is the reload of the document by reload button in the URL bar or the back/forward buttons in browser chrome. If isReload attribute is set to true, some apps may choose not to work so hard to get "fresh" content to display.</p>

    <h3 id="the-beforecacheevictionevent-interface"><span class="secno">4.8 </span>The <code><a href="#beforecacheevictionevent">BeforeCacheEvictionEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="beforecacheevictionevent">BeforeCacheEvictionEvent</dfn> : <a href="http://w3c.github.io/dom/#event" class="external">Event</a> {
  // To be defined.
};</pre>

    <h3 id="the-cacheevictionevent-interface"><span class="secno">4.9 </span>The <code><a href="#cacheevictionevent">CacheEvictionEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="cacheevictionevent">CacheEvictionEvent</dfn> : <a href="http://w3c.github.io/dom/#event" class="external">Event</a> {
  // To be defined.
};</pre>

    <h3 id="the-request-interface"><span class="secno">4.10 </span>The <code><a href="#request">Request</a></code> interface</h3>
    <pre class="idl">// <a href="#request">request</a>
[Constructor(optional <a href="#requestinit">RequestInit</a> init)]
interface <dfn id="request">Request</dfn> {
  readonly attribute unsigned long timeout;
  readonly attribute DOMString url;
  readonly attribute DOMString encoding;
  readonly attribute ByteString method;
  readonly attribute DOMString origin;
  readonly attribute <a href="#mode">Mode</a> mode;
  readonly attribute boolean synchronous;
  readonly attribute unsigned long redirectCount;
  readonly attribute boolean forcePreflight;
  readonly attribute boolean omitCredentials;
  readonly attribute <a href="http://url.spec.whatwg.org/#url" class="external">URL</a> referrer;
  ByteString? <span>getHeader</span>(ByteString <var><a href="#header">header</a></var>);
          attribute sequence&lt;<a href="#header">Header</a>&gt; headers;
  readonly attribute any body;
};

dictionary <dfn id="requestinit">RequestInit</dfn> {
  unsigned long timeout;
  DOMString url;
  DOMString encoding;
  ByteString method = "GET";
  boolean synchronous = false;
  unsigned long redirectCount = 0;
  boolean forcePreflight = false;
  boolean omitCredentials = false;
  <a href="http://url.spec.whatwg.org/#url" class="external">URL</a> referrer;
  sequence&lt;<a href="#header">Header</a>&gt; headers;
  any body = null;
};

enum <dfn id="mode">Mode</dfn> {
  "same origin",
  "tainted x-origin",
  "CORS"
};

dictionary <dfn id="header">Header</dfn> {
  ByteString name;
  ByteString value;
};</pre>

    <h3 id="the-response-interface"><span class="secno">4.11 </span>The <code><a href="#response">Response</a></code> interface</h3>
    <pre class="idl">[Constructor]
interface <dfn id="response">Response</dfn> {
};</pre>

    <h3 id="the-sameoriginresponse-interface"><span class="secno">4.12 </span>The <code><a href="#sameoriginresponse">SameOriginResponse</a></code> interface</h3>
    <pre class="idl">[Constructor(optional <a href="#sameoriginresponseinit">SameOriginResponseInit</a> <var>responseInitDict</var>)]
interface <dfn id="sameoriginresponse">SameOriginResponse</dfn> : <a href="#response">Response</a> {
  void <span>setHeader</span>(ByteString <var>name</var>, ByteString <var>value</var>);
  ByteString? <span>getHeader</span>(ByteString <var><a href="#header">header</a></var>);
          attribute sequence&lt;<a href="#header">Header</a>&gt; headers;
          attribute unsigned short statusCode;
          attribute ByteString statusText;
          attribute DOMString encoding;
          attribute ByteString method;
          attribute any body;
};

dictionary <dfn id="sameoriginresponseinit">SameOriginResponseInit</dfn> {
  unsigned short statusCode = 200;
  ByteString statusText = "OK";
  DOMString encoding;
  ByteString method;
  sequence&lt;<a href="#header">Header</a>&gt; headers;
  any body;
};</pre>

    <h3 id="the-crossoriginresponse-interface"><span class="secno">4.13 </span>The <code><a href="#crossoriginresponse">CrossOriginResponse</a></code> interface</h3>
    <pre class="idl">interface <dfn id="crossoriginresponse">CrossOriginResponse</dfn> : <a href="#response">Response</a> {
};</pre>

    <h3 id="the-cache-interface"><span class="secno">4.14 </span>The <code><a href="#cache">Cache</a></code> interface</h3>
    <pre class="idl">[Constructor((URL or [EnsureUTF16] DOMString)... urls)]
interface <dfn id="cache">Cache</dfn> {
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> match((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString) <var>name</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> add((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString)... <var>responses</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> addResponse((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString) <var>url</var>, <a href="#response">Response</a> <var><a href="#response">response</a></var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> remove((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString)... <var>responses</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> update((<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString)... <var>urls</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> ready();
        attribute <a href="#asyncmap">AsyncMap</a> items;
};

[<a href="http://heycam.github.io/webidl/#MapClass" class="external">MapClass</a>(DOMString, <a href="#response">Response</a>)]
interface <dfn id="asyncmap">AsyncMap</dfn> {
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> get(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> has(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> set(DOMString <var>key</var>, <a href="#response">Response</a> <var>val</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> clear();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> delete(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> items();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> keys();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> values();
};</pre>

    <h3 id="the-cachelist-interface"><span class="secno">4.15 </span>The <code><a href="#cachelist">CacheList</a></code> interface</h3>
    <pre class="idl">// CacheList implements <a href="https://github.com/slightlyoff/ServiceWorker/blob/master/service_worker.ts#L501">asynchronous map</a>
[Constructor(Cache[] iterable),
<a href="http://heycam.github.io/webidl/#MapClass" class="external">MapClass</a>(DOMString, <a href="#cache">Cache</a>)]
interface <dfn id="cachelist">CacheList</dfn> {
  (<a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> or <a href="#response">Response</a>) match(DOMString <var>name</var>, (<a href="http://url.spec.whatwg.org/#url" class="external">URL</a> or [EnsureUTF16] DOMString) <var>url</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> get(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> has(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> set(DOMString <var>key</var>, <a href="#cache">Cache</a> <var>val</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> clear();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> delete(DOMString <var>key</var>);
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> items();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> keys();
  <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> values();
};</pre>

    <p class="critical">The following issues should be addressed in the WebIDL specification: the methods <code>keys()</code> and <code>values()</code> are not allowed to be declared as interface members of an interface declared with the [<a href="http://heycam.github.io/webidl/#MapClass" class="external">MapClass</a>] extended attribute; the return type of <code>get(key)</code>, <code>has(key)</code>, <code>set(key, val)</code>, <code>clear()</code>, <code>delete(key)</code> is meant to be declared as pre-defined IDL fragment. Namely, the interface declared with [<a href="http://heycam.github.io/webidl/#MapClass" class="external">MapClass</a>] extended attribute cannot fully support creating asynchronous map objects.</p>

    <h3 id="events"><span class="secno">4.16 </span>Events summary</h3>

    <p><em>This section is non-normative.</em></p>

    <p>The following events are dispatched on the extended <code>Navigator</code> object:</p>
    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn title="event-serviceworker-serviceworkerinstall" id="event-serviceworker-serviceworkerinstall"><code>serviceworkerinstall</code></dfn></td>
          <td><code>Event</code></td>
          <td>A new worker becomes in-waiting.</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-serviceworkerreplaced" id="event-serviceworker-serviceworkerreplaced"><code>serviceworkerreplaced</code></dfn></td>
          <td><code>Event</code></td>
          <td>A new worker takes over via <code><a href="#installevent">InstallEvent</a></code>'s <span>replace</span>() method.</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-serviceworkerreloadpage" id="event-serviceworker-serviceworkerreloadpage"><code>serviceworkerreloadpage</code></dfn></td>
          <td><code><a href="#reloadpageevent">ReloadPageEvent</a></code></td>
          <td>Restarting all <code><span>windows</span></code> with the new worker via <code><a href="#installevent">InstallEvent</a></code>'s <span>reloadAll</span>() method.</td>
        </tr>
      </tbody>
    </table>

    <p>The following events are dispatched on <code><a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a></code> object:</p>
    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn title="event-serviceworker-install" id="event-serviceworker-install"><code>install</code></dfn></td>
          <td><code><a href="#installevent">InstallEvent</a></code></td>
          <td>A worker is downloaded and being setup to handle events (navigations, alerts, etc.)</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-activate" id="event-serviceworker-activate"><code>activate</code></dfn></td>
          <td><code><a href="#installphaseevent">InstallPhaseEvent</a></code></td>
          <td>A worker becomes the active event worker for a mapping</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-fetch" id="event-serviceworker-fetch"><code>fetch</code></dfn></td>
          <td><code><a href="#fetchevent">FetchEvent</a></code></td>
          <td>This worker is meant to decide the disposition of a request.</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-beforeevicted" id="event-serviceworker-beforeevicted"><code>beforeevicted</code></dfn></td>
          <td><code><a href="#beforecacheevictionevent">BeforeCacheEvictionEvent</a></code></td>
          <td>Before cache is about to be evicted.</td>
        </tr>
        <tr>
          <td><dfn title="event-serviceworker-evicted" id="event-serviceworker-evicted"><code>evicted</code></dfn></td>
          <td><code><a href="#cacheevictionevent">CacheEvictionEvent</a></code></td>
          <td>Cache is about to be evicted.</td>
        </tr>
      </tbody>
    </table>

    <h2 id="bootstrap-with-a-service-worker"><span class="secno">5 </span>Bootstrap with a service worker</h2>
    <p>A <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> MUST be installed either by invoking the <a title="serviceworker-navigator-registerserviceworker" href="#serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> method within web pages or by setting the member <code>service_worker</code> of the manifest to the URL of a service worker.</p>

    <h3 id="the-registerserviceworker()-method"><span class="secno">5.1 </span>The <a title="serviceworker-navigator-registerserviceworker" href="#serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> method</h3>
    <p><a title="concept-serviceworker" href="#concept-serviceworker">Service worker</a>s must be able to be installed by web pages. A user must visit a web page or web application for the process to start.</p>
    <div class="example">
      <pre title="Installation">// Document hosted at: http://videos.example.com/index.html
navigator.registerServiceWorker("/*", "/assets/v1/worker.js").then(
  function(serviceWorker) {
    console.log("success!");
    serviceWorker.postMessage("Howdy from your installing page.");
    // To use the serviceWorker immediately, you might call window.location.reload()
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });</pre>
    </div>

    <p>The example shows the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> hosted at <code>/assets/v1/worker.js</code> is installed by the web page hosted at <code>http://videos.example.com/index.html</code>.</p>
    <div class="example">
      <pre title="ServiceWorker script serving onfetch event">// Service worker script hosted at: /assets/v1/worker.js
this.version = 1;

var base = "http://videos.example.com";
var inventory = new URL("/services/inventory/data.json", base) + "";

this.addEventListener("install", function(e) {
});

this.addEventListener("fetch", function(e) {
  var url = e.request.url;
  console.log(url);
  if (url == inventory) {
    e.respondWith(new SameOriginResponse({
      statusCode: 200,
      body: JSON.stringify({
        videos: { /* ... */ }
      })
    }));
  }
});
        </pre>
    </div>
    <p>
    Once the <code>worker.js</code> in the example is successfully installed, the "success!"" message will be sent to the console and, crucially, the next time the user visits <code>index.html</code> or any other page located at <code>http://videos.example.com/</code>, <code>worker.js</code> will be consulted about what to do and what content to load even if the device has no Internet connection. On pages that are <em>controlled</em> in this way, other resources (like images in the document body) are also requested first from <code>worker.js</code> before the normal browser cache is consulted for them.</p>

    <h3 id="the-member-service_worker-of-the-manifest"><span class="secno">5.2 </span>The member <em><code>service_worker</code></em> of the manifest</h3>
    <p class="critical">This section remains unspecified as the architecture has not been clarified nor has it been aligned with the standards track <a href="http://w3c.github.io/manifest/" class="external">manifest</a> specification. Here's the <a href="https://github.com/slightlyoff/ServiceWorker/issues/137">discussion thread</a> in Github repository.</p>

    <h3 id="controlled-and-uncontrolled-documents"><span class="secno">5.3 </span><em>Controlled</em> and <em>uncontrolled</em> documents</h3>
    <p>The first time <code>http://videos.example.com/index.html</code> is loaded, all the resources it requests will come from the network. That means that even if the browser runs the install snippet for <code>worker.js</code>, <a href="http://fetch.spec.whatwg.org/#concept-fetch" class="external">fetch</a>es it, and finishes installing it before it begins <a href="http://fetch.spec.whatwg.org/#concept-fetch" class="external">fetch</a>ing logo.png, the new <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> script would not be consulted about loading logo.png. This is the first rule of <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s:</p>
    <ul>
      <li>Documents live out their whole lives using the service worker they start with.</li>
    </ul>
    <p>This means that if a document starts life without a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> it would not suddenly get a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> later in life, even if one is installed for a matching bit of URL space during the doucment's lifetime. This means documents that are loaded with a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> which might later call <code>unregisterServiceWorker()</code> do not become controlled by that worker. Put another way, <a title="serviceworker-navigator-registerserviceworker" href="#serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> and <code>unregisterServiceWorker()</code> only affect subsequent navigations.</p>


    <h3 id="longest-prefix-matching"><span class="secno">5.4 </span>Longest-prefix matching</h3>
    <div class="example">
      <pre title="Longest-prefix matching [ex 1]">&lt;!DOCTYPE html&gt;
&lt;!-- http://www.example.com/foo.html --&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;script&gt;
      navigator.registerServiceWorker("/foo*", "/foo_worker.js");
    &lt;/script&gt;
  &lt;/head&gt;
&lt;/html&gt;</pre>
      <pre title="Longest-prefix matching [ex 2]">&lt;!DOCTYPE html&gt;
&lt;!-- http://www.example.com/foo/bar.html --&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;script&gt;
      navigator.registerServiceWorker("/foo/bar*", "/foo/bar_worker.js");
    &lt;/script&gt;
  &lt;/head&gt;
&lt;/html&gt;</pre>
    </div>
    <p>To break what might otherwise be ties when matching URLs, navigations are mapped to <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s by longest-prefix-match. Note that the <code>*</code> can only occur at the end of a matching rule, so attempts to register <code>/foo/*/bar</code> or <code>*bar</code> will <a href="http://heycam.github.io/webidl/#dfn-throw" class="external">throw</a> exceptions. Similarly, registering a scope that includes a <code>"?"</code> or <code>"#"</code> will also <a href="http://heycam.github.io/webidl/#dfn-throw" class="external">throw</a>s exceptions.</p>
    <p>In the above example with registrations for <code>/foo*</code> and <code>/foo/bar*</code>, the following matches would be made when navigating to the following URLs under <code>http://www.example.com</code>:</p>
    <table border="1">
      <tr>
        <th>Scope (Pattern)</th>
        <th>URL</th>
      </tr>
      <tr>
        <td><code>/foo</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo?blarg</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/thinger.html</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foobar.html</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/other/thinger.html</code></td>
        <td><code>/foo_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar</code></td>
        <td><code>/foo/bar_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/</code></td>
        <td><code>/foo/bar_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/thinger.html</code></td>
        <td><code>/foo/bar_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/baz/thinger.html</code></td>
        <td><code>/foo/bar_worker.js</code></td>
      </tr>
      <tr>
        <td><code>/index.html</code></td>
        <td><code>&lt;fallback to native&gt;</code></td>
      </tr>
      <tr>
        <td><code>/whatevs/index.html</code></td>
        <td><code>&lt;fallback to native&gt;</code></td>
      </tr>
    </table>
    <p><code>&lt;fallback to native&gt;</code> is the browser's built-in behavior for fetching resources - the thing the Fetch Service defers to when it does not handle a fetch with <code>e.respondWith()</code>.</p>
    <p class="note">If <code>e.respondWith()</code> is not called when handling a connection in <code>/foo/bar_worker.js</code>, it does not cascade to <code>/foo_worker.js</code>, it falls back to the browser's built-in network behavior.</p>

    <h3 id="last-registration-wins"><span class="secno">5.5 </span><dfn>Last-registration wins</dfn></h3>
    <p>The registration system is also last-registration-wins. That means if two pages on <code>www.example.com</code> set a registration to control <code>/*</code>, the one a user visits second (assuming the first does not interfere) will be installed and over-write the previous registration.</p>

    <p>This makes sense because registration is the same as replacement. That is to say, if you have content that wants to replace the existing <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> with one at a different URL (perhaps a heavy-handed form of "new version"), registering the new URL is the way that you indicate that the old registration is no longer the preferred one.</p>

    <h3 id="cross-origin-limitation"><span class="secno">5.6 </span>Cross-origin limitation</h3>
    <p>One of the concerns that major applications hit is "how do I host things from a CDN?" By definition, these are servers in other places, often on other domains, that your content references. Can <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s be hosted on CDNs? No, this is not allowed since <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s can create the possibility of an XSS vulnerability, etc.</p>

    <p>But they can include resources (via <code>importScripts()</code>) that are.</p>

    <h2 id="lifecycle-of-a-service-worker"><span class="secno">6 </span>Lifecycle of a service worker</h2>
    <p>The browser might unceremoniously kill your <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> if it is idle, or even stop it mid-work and re-issue the request to a different instance of the worker. There are no guarantees about how long a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> will run. <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s should be written to avoid holding global state. This cannot be stressed enough: write your workers as though they will die after every request.</p>
    <p><a title="concept-serviceworker" href="#concept-serviceworker">Service worker</a>s are shared resources. A single worker might be servicing requests from multiple tabs or documents. Never assume that only one document is talking to a given <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>. If you care about where a request is coming from or going to, use the <code>.window</code> property of the <code>onfetch</code> event; but do not create state that you care about without serializing it somewhere like IndexedDB.</p>


    <h2 id="upgrade-with-a-new-version"><span class="secno">7 </span>Upgrade with a new version</h2>

    <h3 id="wait-for-restart"><span class="secno">7.1 </span>Wait-for-restart</h3>
    <p>The default policy is that this new tab will be controlled by v1. This is done to prevent the crazy-town scenario of multiple <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> versions running at the same time, possibly creating conflicts for IndexedDB schemas, content caches, and the like. Yes, there is a small window during <code>oninstall</code> when v2 will be running at the same time as v1, but they would not both be serving content. The advice then is: do not do irreversible things during oninstall. It is a good place to get a jump on populating caches (with unique names if the new content is reliant on the new <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>), but a bad place to do things like schema and model upgrades for your application.</p>

    <p>The alternative scenario is one in which the new version of your <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> is discovered and installed and no documents are running against v1. This could happen because:</p>

    <ul>
      <li>v1 was installed by a page that was loaded "naked", but which was never reloaded so as to start under the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>.</li>
      <li>The browser fetched an update of it is own volition. It is allowed to do that!</li>
      <li>Between the time <code>oninstall</code> started for the v2 <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> and when <code>waitUntil()</code> was finally satisfied, all of the application's windows were closed.</li>
    </ul>

    <p>When this happens, v2 instantly becomes the active <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>, so the next time you navigate to a URL controlled by the registration, v2 would get first crack at it.</p>

    <p>Indeed, v2 will become the active <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> just as soon as all v1 documents are closed.</p>

    <p>When v2 does become the active <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>, another event - <code>onactivate</code> - is sent to v2. This happens before any fetches are dispatched. This is the ideal time to upgrade database schemas and the like, but be careful not to do too much work. Applications will be blocked from loading while <code>onactivate</code> is being serviced (including any extensions asked for via <code>e.waitUntil()</code>, which is also available to <code>onactivate</code> handlers). Treat <code>onactivate</code> as a time to stake your claim as the new version but beware doing more than that lest you make your app unavailable!</p>

    <h3 id="replacement"><span class="secno">7.2 </span>Replacement</h3>
    <p>An alternative policy is available for the daring: a new <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> can choose to cut-in and replace an existing one. And before you ask, yes, this does break the first rule. But not much.</p>

    <p>To replace an existing <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>, use the <code>.replace()</code> method of the <code>oninstall</code> event during the event dispatch. In fact, you can even call <code>.replace()</code> on the very first install of a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>, which will now make your <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> the proud owner of all windows/tabs whose URLs match the registration origin and scope including the page that registered it.</p>

    <p>Here is an example: we'll compare the versions to ensure that they are not so far apart that stepping in would break things; leaving the old <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> in place if the version skew is too great and taking over if it is a difference our new version is confident it can handle. Consider v1.3 vs. v1.0:</p>

    <div class="example">
      <pre title="Replacement">// caching.js
this.version = 1.3;

var assetBase = "/assets/v" + parseInt(this.version) + "/";
var shellCacheName = "shell-v" + parseInt(this.version);
var contentCacheName = "content";

this.addEventListener("install", function(e) {

  // Create a cache of resources. Begins the process of fetching them.
  var shellResources = new Cache(
    assetBase + "/base.css",
    assetBase + "/app.js",
    assetBase + "/logo.png",
    assetBase + "/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  caches.set(shellCacheName, shellResources);

  // Prepare an additional cache that we can add items to later
  caches.has(contentCacheName).catch(function() {
    caches.set(contentCacheName, new Cache());
  });

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());

  // If and only if we're less than one major version ahead, cut-in and start
  // serving resources.
  if (parseInt(e.previousVersion) == parseInt(this.version)) {
    // Note: replacement won't happen until the Promise passed to
    // e.waitUntil resolves
    e.replace();
  }
});

// ...onfetch, etc...</pre>
    </div>
    <p>The <code>previousVersion</code> field of the event is filled in using a structured clone of the global version property set by the last execution of the previous <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>. It is a good idea both to always set a version and, sort of obviously, not to make it something that cannot be cloned or which varies.</p>

    <p>What of the old <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>? What happens to it?</p>

    <p>The replacing <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> can send a message to the old <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> in <code>oninstalled</code> using <code>e.previous.postMessage()</code>. This can blossom into a bi-directional discussion if both sides have registered <code>onmessage</code> handlers, but that is out of the scope of this document for now.</p>

    <h2 id="offline-first-resource-handling"><span class="secno">8 </span>Offline-first resource handling</h2>

    <h3 id="fetchevent-handling"><span class="secno">8.1 </span><code><a href="#fetchevent">FetchEvent</a></code> handling</h3>
    <p>Once installed, <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s can choose to handle resource requests. A navigation that matches the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>'s origin and scope</p>

    <p>Here is an example of a <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> that only handles a single resource (<code>/services/inventory/data.json</code>) but which logs out requests for all resources it is consulted for:</p>

    <div class="example">
      <pre title="onfetch handling in a service worker">// hosted at: /assets/v1/worker.js
this.version = 1;

var base = "http://videos.example.com";
var inventory = new URL("/services/inventory/data.json", base) + "";

this.addEventListener("install", function(e) {
});

this.addEventListener("fetch", function(e) {
  var url = e.request.url;
  console.log(url);
  if (url == inventory) {
    e.respondWith(new SameOriginResponse({
      statusCode: 200,
      body: JSON.stringify({
        videos: { /* ... */ }
      })
    }));
  }
});</pre>
    </div>
    <p>The contents of all but the inventory will be handled by the normal browser resource fetching system because the onfetch event handler did not call <code>respondWith()</code> when invoked with their requests. The first time the app is loaded (before the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> is installed), <code>data.json</code> will also be fetched from the network. Thereafter it will be computed by the <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a> instead. The important thing to remember here is that normal resource loading is the fallback behavior for fetch events.</p>
    <p>When combined with access to IndexedDB and a new form of <code><a href="#cache">Cache</a></code>, the ability to respond with arbitrary content is incredibly powerful. Since installed <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s are invoked even when offline, <a title="concept-serviceworker" href="#concept-serviceworker">service worker</a>s enable apps that are "offline by default" once installed.</p>

    <h3 id="navigation-vs-fetch"><span class="secno">8.2 </span>Navigation vs Fetch</h3>
    <p>Description</p>

    <h3 id="fallback-rule"><span class="secno">8.3 </span>Fallback rule</h3>
    <p>Description</p>

    <h3 id="redirects"><span class="secno">8.4 </span>Redirects</h3>
    <p>Description</p>

    <h3 id="cross-origin-resources"><span class="secno">8.5 </span>Cross-origin resources</h3>
    <p>Description</p>

    <h2 id="caching"><span class="secno">9 </span>Caching</h2>

    <h3 id="ready-with-populated-cache-object"><span class="secno">9.1 </span>Ready with populated cache object</h3>
    <p>Each service worker has a global <code>caches</code> map which holds instances of <code><a href="#cache">Cache</a></code>. As its name implies, a <code><a href="#cache">Cache</a></code> object is a repository of stored <code><a href="#response">Response</a></code> objects; or in this case, <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a>s which represent <code><a href="#response">Response</a></code>s which may or may not yet be available from the network.</p>
    <p>Using <code><a href="#cache">Cache</a></code>s is perhaps simpler than talking about them, so here is some tiny example code that implements the <code>oninstall</code> event, starts populating a single <code><a href="#cache">Cache</a></code> object with content, and tells the system that the service worker is ready if-and-only-if all the resources in the cache are downloaded.</p>
    <div class="example">
      <pre title="Cache control in service worker script">// Service worker script hosted at: /assets/v1/caching.js
this.version = 1;

var base = "http://videos.example.com";
this.addEventListener("install", function(e) {

  // Create a cache of resources. Begins the process of fetching them.
  // URLs are relative to the service worker
  var shellResources = new Cache(
    base + "/assets/v1/base.css",
    base + "/assets/v1/app.js",
    base + "/assets/v1/logo.png",
    base + "/assets/v1/intro_video.webm",
  );

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());

  // Add Cache to the global so it can be used later during onfetch
  caches.set("shell-v1", shellResources);
});</pre>
    </div>
    <p><code><a href="#cache">Cache</a></code> objects contain an <code>items</code> map which contains <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a>s for each of the resources, keyed by their <a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#absolute-url" class="external">absolute URL</a>. When all of the resources added to a cache are downloaded successfully, the <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> vended by <code>ready()</code> method settles successfully. Our example wires that up to the resolution to the completion of installation, meaning this service worker will not be "activated" until at least that set of resources is cached and ready.</p>

    <h3 id="serving-cached-resources"><span class="secno">9.2 </span>Serving Cached Resources</h3>
    <p>Now that we have got some resources in a cache, what can we do with them? Most of the service worker interfaces that can take <code><a href="#response">Response</a></code> instances are designed to also work with <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a>s that wrap <code><a href="#response">Response</a></code>s. Here is an expanded version of <code>caching.js</code> that adds an <code>onfetch</code> handler to serve the URLs in question:</p>

    <div class="example">
      <pre title="Cache control in service worker script">// Service worker script hosted at: /assets/v1/caching.js
this.version = 1;

this.addEventListener("install", function(e) {
  // Create a cache of resources. Begins the process of fetching them.
  var shellResources = new Cache(
    "/app.html",
    "/assets/v1/base.css",
    "/assets/v1/app.js",
    "/assets/v1/logo.png",
    "/assets/v1/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  caches.set("shell-v1", shellResources);

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());
});

this.addEventListener("fetch", function(e) {
  // No "onfetch" events are dispatched to the ServiceWorker until it
  // successfully installs.

  // All operations on caches are async, including matching URLs, so we use
  // Promises heavily. e.respondWith() even takes Promises to enable this:
  e.respondWith(caches.match("shell-v1", e.request.url));
});</pre>
    </div>

    <p>The behavior of <code>respondWith()</code> is conditional: if the cache returns a valid <code><a href="#response">Response</a></code>, that is what is sent back to the requesting document. If the <a href="http://w3c.github.io/dom/#promises" class="external">Promise</a> generated by <code>match()</code> returns anything else or rejects with an error, the request is then routed to the browser's HTTP stack (as would happen without the service worker).</p>

    <p>The <code>caches.match()</code> dance is a bit wordy, so to cut this short there is a match convenience method on the global <code>caches</code> object to make our <code>onfetch</code> handler shorter but instead of taking one parameter (the URL), it takes two (the cache name and the URL):</p>

    <div class="example">
      <pre title="Cache control in service worker script">this.addEventListener("fetch", function(e) {
  // Abbreviated onfetch handler
  e.respondWith(caches.match("shell-v1", e.request.url));
});</pre>
    </div>

    <h2 id="extensions"><span class="secno">10 </span>Extensions</h2>
    <p class="critical">The expectation is that service workers are meant to be extensible from other specifications. As of now, <a href="http://www.w3.org/2012/sysapps/web-alarms/">TaskScheduler</a> and <a href="https://dvcs.w3.org/hg/push/raw-file/tip/index.html">Puah API</a> would be the prime candidates and more will come. That said, we want to make sure that the future works won't be adding synchronous cruft, etc. This section will provide template text for how to extend the service workers.</p>

    <h2 class="no-num" id="references">References</h2>
    <div id="anolis-references"><dl><dt id="refsDOM">[DOM]
<dd><cite><a href="http://w3c.github.io/dom/">DOM</a></cite>, Anne van Kesteren, Aryeh Gregor, Ms2ger et al.. W3C.

<dt id="refsECMASCRIPT">[ECMASCRIPT]
<dd><cite><a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ECMAScript Language Specification</a></cite>. ECMA.

<dt id="refsHTML">[HTML]
<dd><cite><a href="http://www.w3.org/html/wg/drafts/html/master/">HTML</a></cite>, Robin Berjon, Steve Faulkner, Travis Leithead et al.. W3C.

<dt id="refsHTTP">[HTTP]
<dd><cite><a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a></cite>, Roy Fielding, James Gettys, Jeffrey Mogul et al.. IETF.

<dt id="refsRFC2119">[RFC2119]
<dd><cite><a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a></cite>, Scott Bradner. IETF.

<dt id="refsURL">[URL]
<dd><cite><a href="http://url.spec.whatwg.org/">URL Standard</a></cite>, Anne van Kesteren. WHATWG.

<dt id="refsWEBIDL">[WEBIDL]
<dd><cite><a href="http://dev.w3.org/2006/webapi/WebIDL/">Web IDL</a></cite>, Cameron McCormack. W3C.

</dl></div>

    <h2 class="no-num" id="acknowledgments">Acknowledgments</h2>

    <p>The editors would like to thank
    Jake ("B.J.") Archibald,
    David Barrett-Kahn,
    Andrew Betts,
    Greg Billock,
    Aaron Boodman,
    Darin Fisher,
    Alec Flett,
    Anne van Kesteren,
    Anssi Kostiainen,
    Dominique Hazael-Massieux,
    Dave Herman,
    Michael Nordman,
    Soledad Penads,
    Michael Sanford,
    Jonas Sicking,
    Chris Wilson,
    Ivan uak
    for their contributions to this specification.</p>

    <p>Thanks also to all those who have helped to improve this specification
    by sending suggestions and corrections. (Please, keep bugging us with your
    issues!)</p>
  

</div>