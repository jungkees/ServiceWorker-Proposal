<!DOCTYPE html><html lang="en-US"><head>
    <meta charset="utf-8">
    <title>Service Workers</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://www.w3.org/StyleSheets/TR/W3C-ED" rel="stylesheet">
  </head>
  <body>
    <div class="head">
      <p><a href="http://www.w3.org/"><img alt="W3C" height="48" src="https://www.w3.org/Icons/w3c_home" width="72"></a></p>

      <h1 class="head" id="serviceworker">Service Workers</h1>
      <h2 class="dontpublish no-num no-toc" id="subtitle">Soon-to-be-shipped draft</h2>
      <h2 class="no-num no-toc" id="w3c-doctype">Editor's Draft 16 December 2013</h2>

      <dl>
        <dt>This Version:</dt>
        <dd class="dontpublish"><a href="http://w3c.github.io/serviceworker">http://w3c.github.io/serviceworker</a></dd>
        <dt class="dontpublish">Participate:</dt>
        <dd class="dontpublish">Send feedback to
        <a href="mailto:public-webapps@w3.org?subject=%ServiceWorker%5D%20">public-webapps@w3.org</a>
        (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>) or
        <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG&amp;component=ServiceWorker">file a bug</a>
        (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WebAppsWG&amp;component=ServiceWorker&amp;resolution=---">open bugs</a>)
        <dd class="dontpublish"><a href="http://irc.w3.org">IRC: #webapps</a>

        <dt class="dontpublish">Version History:
        <dd class="dontpublish"><a href="https://github.com/jungkees/ServiceWorker-Proposal/commits/gh-pages">https://github.com/jungkees/ServiceWorker-Proposal/commits/gh-pages</a>

        <dt>Previous Versions:</dt>
        <dd><a href="http://w3c.github.io/serviceworker">http://w3c.github.io/serviceworker</a></dd>

        <dt>Editor:</dt>
        <dd><a href="http://infrequently.org/">Alex Russell</a>,
         <a href="http://www.google.com/">Google</a>
        </dd>
        <dd><a href="mailto:jungkee.song@samsung.com">Jungkee Song</a>,
         <a href="http://www.samsung.com/sec/">Samsung Electronics</a>
        </dd>
      </dl>
    </div>

    <div class="w3conly">
<!--begin-copyright-->
<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2013 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>
<!--end-copyright--></div>

    <hr class="top">

    <div class="dontpublish"><!-- ED version -->
      <h2 class="no-num no-toc" id="specabstract">Abstract</h2>

      <p>This specification describes the method for web applications to enable background functionality, including hooks to enable bootstrapping of web applications while offline.</p>

      <h2 class="no-num no-toc" id="sotd">Status of this Document</h2>

      <p><em>This section describes the status of this document at the time of its
      publication. Other documents may supersede this document. A list of current
      W3C publications and the latest revision of this technical report can be
      found in the <a href="http://www.w3.org/TR/">W3C technical reports index</a>
      at http://www.w3.org/TR/.</em></p>

      <p>If you wish to make comments regarding this document in a manner
      that is tracked by the W3C, please submit them via using <a href="http://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG">our public bug database</a>, or please send comments to
      <a href="mailto:public-webapps@w3.org?subject=%5BServiceWorker%5D%20">public-webapps@w3.org</a>
      (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archived</a>)
      with <samp><a href="#serviceworker-0">[ServiceWorker]</a></samp> at the start of the subject line.</p>

      <p>The W3C <a href="http://www.w3.org/2008/webapps/">Web Applications Working
      Group</a> is the W3C working group responsible for this specification's progress along the W3C Recommendation track. This specification is the 16 December 2013 Editor's Draft.</p>

      <p>Publication as an Editor's Draft does not imply endorsement by the W3C
      Membership. This is a draft document and may be updated, replaced or
      obsoleted by other documents at any time. It is inappropriate to cite this
      document as other than work in progress.</p>

      <p>This document was produced by a group operating under the
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004
      W3C Patent Policy</a>. W3C maintains a
      <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public
      list of any patent disclosures</a> made in connection with the deliverables of
      the group; that page also includes instructions for disclosing a patent. An
      individual who has actual knowledge of a patent which the individual believes
      contains
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
      Claim(s)</a> must disclose the information in accordance with
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
      6 of the W3C Patent Policy</a>.</p>
    </div>

    <h2 class="no-num no-toc" id="toc">Table of Contents</h2>
    
<!--begin-toc-->
<ol class="toc">
 <li><a href="#introduction"><span class="secno">1 </span>Introduction</a>
  <ol class="toc">
   <li><a href="#motivations"><span class="secno">1.1 </span>Offline-first web applications: the motivations</a></li>
   <li><a href="#lack-of-the-controllability-with-the-existing-solution:-appcache"><span class="secno">1.2 </span>Lack of the controllability with the existing solution: AppCache</a></li>
   <li><a href="#service-workers"><span class="secno">1.3 </span>Service workers</a></ol></li>
 <li><a href="#conformance"><span class="secno">2 </span>Conformance</a>
  <ol class="toc">
   <li><a href="#dependencies"><span class="secno">2.1 </span>Dependencies</a></li>
   <li><a href="#extensibility"><span class="secno">2.2 </span>Extensibility</a></ol></li>
 <li><a href="#terminology"><span class="secno">3 </span>Terminology</a></li>
 <li><a href="#interfaces"><span class="secno">4 </span>Interfaces</a>
  <ol class="toc">
   <li><a href="#extensions-to-the-navigator-object"><span class="secno">4.1 </span>Extensions to the <code>Navigator</code> object</a></li>
   <li><a href="#the-serviceworker-interface"><span class="secno">4.2 </span>The <code>ServiceWorker</code> interface</a></li>
   <li><a href="#the-serviceworkerglobalscope-interface"><span class="secno">4.3 </span>The <code>ServiceWorkerGlobalScope</code> interface</a></li>
   <li><a href="#the-reloadpageevent-interface"><span class="secno">4.4 </span>The <code>ReloadPageEvent</code> interface</a></li>
   <li><a href="#the-installevent-interface"><span class="secno">4.5 </span>The <code>InstallEvent</code> interface</a></li>
   <li><a href="#the-installphaseevent-interface"><span class="secno">4.6 </span>The <code>InstallPhaseEvent</code> interface</a></li>
   <li><a href="#the-fetchevent-interface"><span class="secno">4.7 </span>The <code>FetchEvent</code> interface</a></li>
   <li><a href="#the-beforecacheevictionevent-interface"><span class="secno">4.8 </span>The <code>BeforeCacheEvictionEvent</code> interface</a></li>
   <li><a href="#the-cacheevictionevent-interface"><span class="secno">4.9 </span>The <code>CacheEvictionEvent</code> interface</a></li>
   <li><a href="#the-request-interface"><span class="secno">4.10 </span>The <code>Request</code> interface</a></li>
   <li><a href="#the-response-interface"><span class="secno">4.11 </span>The <code>Response</code> interface</a></li>
   <li><a href="#the-sameoriginresponse-interface"><span class="secno">4.12 </span>The <code>SameOriginResponse</code> interface</a></li>
   <li><a href="#the-crossoriginresponse-interface"><span class="secno">4.13 </span>The <code>CrossOriginResponse</code> interface</a></li>
   <li><a href="#the-cache-interface"><span class="secno">4.14 </span>The <code>Cache</code> interface</a></li>
   <li><a href="#the-cachelist-interface"><span class="secno">4.15 </span>The <code>CacheList</code> interface</a></li>
   <li><a href="#events"><span class="secno">4.16 </span>Events summary</a></ol></li>
 <li><a href="#bootstrap-with-a-service-worker"><span class="secno">5 </span>Bootstrap with a service worker</a>
  <ol class="toc">
   <li><a href="#the-registerserviceworker()-method"><span class="secno">5.1 </span>The <span title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></span> method</a></li>
   <li><a href="#the-member-serviceworker-of-the-manifest"><span class="secno">5.2 </span>The member <em><code>serviceworker</code></em> of the manifest</a></li>
   <li><a href="#controlled-and-uncontrolled-documents"><span class="secno">5.3 </span><em>Controlled</em> and <em>uncontrolled</em> documents</a></li>
   <li><a href="#longest-prefix-matching"><span class="secno">5.4 </span>Longest-prefix matching</a></li>
   <li><a href="#last-registration-wins"><span class="secno">5.5 </span>Last-registration wins</a></li>
   <li><a href="#cross-origin-limitation"><span class="secno">5.6 </span>Cross-origin limitation</a></ol></li>
 <li><a href="#lifecycle-of-a-service-worker"><span class="secno">6 </span>Lifecycle of a service worker</a></li>
 <li><a href="#upgrade-with-a-new-version"><span class="secno">7 </span>Upgrade with a new version</a>
  <ol class="toc">
   <li><a href="#wait-for-restart"><span class="secno">7.1 </span>Wait-for-restart</a></li>
   <li><a href="#replacement"><span class="secno">7.2 </span>Replacement</a></ol></li>
 <li><a href="#offline-first-resource-handling"><span class="secno">8 </span>Offline-first resource handling</a>
  <ol class="toc">
   <li><a href="#fetchevent-handling"><span class="secno">8.1 </span><code>FetchEvent</code> handling</a></li>
   <li><a href="#navigation-vs-fetch"><span class="secno">8.2 </span>Navigation vs Fetch</a></li>
   <li><a href="#fallback-rule"><span class="secno">8.3 </span>Fallback rule</a></li>
   <li><a href="#redirects"><span class="secno">8.4 </span>Redirects</a></li>
   <li><a href="#cross-origin-resources"><span class="secno">8.5 </span>Cross-origin resources</a></ol></li>
 <li><a href="#caching"><span class="secno">9 </span>Caching</a></li>
 <li><a href="#future-extension"><span class="secno">10 </span>Future extension</a></li>
 <li><a class="no-num" href="#references">References</a></li>
 <li><a class="no-num" href="#acknowledgments">Acknowledgments</a></ol>
<!--end-toc-->

    <h2 id="introduction"><span class="secno">1 </span>Introduction</h2>
    <p><em>This section is non-normative.</em></p>

    <h3 id="motivations"><span class="secno">1.1 </span>Offline-first web applications: the motivations</h3>
    <p>Web applications are traditionally premised on the assumption that the network is reachable. This assumption pervades the platform. <a href="#refsHTML">[HTML]</a> documents are loaded over HTTP and traditionally <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch" title="fetch">fetch</a> all of their sub-resources via subsequent <a href="#refsHTTP">[HTTP]</a> requests. This places web content at a disadvantage versus other technology stacks.</p>

    <h3 id="lack-of-the-controllability-with-the-existing-solution:-appcache"><span class="secno">1.2 </span>Lack of the controllability with the existing solution: AppCache</h3>
    <p>AppCache is declarative. Web developers give the browser a manifest and magic happens. This has well-known limitations that the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s work around by giving developers the lower-level primitives that AppCache is described in terms of.</p>

    <h3 id="service-workers"><span class="secno">1.3 </span>Service workers</h3>
    <p><dfn id="concept-serviceworker" title="concept-serviceworker">Service worker</dfn>s are a new feature for the web platform that lets a script persistently cache resources and handle all resource requests for an application even when the network is not available. <a href="#concept-serviceworker" title="concept-serviceworker">Service worker</a>s are bit of scripts that can listen for network events (such as resource requests), manage content caches, and thus decide what content to display when a URL is requested. <a href="#refsURL">[URL]</a> Putting it all together, <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s give you a way to build applications that work offline.</p>

    <div class="example">
      <p>Some simple code to install a service worker and control the document from within the worker script:</p>

      <pre title="Installation from a page">// Document hosted at: http://videos.example.com/index.html
navigator.registerServiceWorker("/assets/v1/serviceworker.js", { scope: "/*" }).then(
  function(serviceWorker) {
    serviceWorker.postMessage("Howdy from your installing page.");
    // To use the serviceWorker immediately, you might call window.location.reload()
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });</pre>

      <p>Listen to fetch event and cache necessary resources from the script:</p>
      <pre title="ServiceWorker script">// Service worker script hosted at: http://videos.example.com/assets/v1/serviceworker.js
this.addEventListener("install", function(e) {
  // Tell the system that this service worker can handle fetch events.
  e.services = ["fetch"];
});

this.addEventListener("fetch", function(e) {
  // DIY either offline! or online as fallback.

  // Create a cache of resources. Begins the process of fetching them.
  // URLs are relative to the service worker
  var shellResources = new Cache(
    base + "/assets/v1/base.css",
    base + "/assets/v1/app.js",
    base + "/assets/v1/logo.png",
    base + "/assets/v1/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  this.caches.set("shell-v1", shellResources);

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());
});</pre>
    </div>

    <h2 id="conformance"><span class="secno">2 </span>Conformance</h2>

    <p>All diagrams, examples, and notes in this specification are
    non-normative, as are all sections explicitly marked non-normative.
    Everything else in this specification is normative.</p>

    <p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
    NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
    "OPTIONAL" in the normative parts of this specification are to be
    interpreted as described in RFC2119. For readability, these words do
    not appear in all uppercase letters in this specification.
    <a href="#refsRFC2119">[RFC2119]</a></p>

    <h3 id="dependencies"><span class="secno">2.1 </span>Dependencies</h3>
    <p>This specification relies on several underlying specifications.</p>

    <ul>
      <li><p>DOM Living Standard <a href="#refsDOM">[DOM]</a></li>
      <li><p>HTML Living Standard <a href="#refsHTML">[HTML]</a></li>
      <li><p>ECMAScript Langauage Specification <a href="#refsECMASCRIPT">[ECMASCRIPT]</a></li>
      <li><p>Web IDL <a href="#refsWEBIDL">[WEBIDL]</a></li>
    </ul>
    <p>It uses the typographic conventions from HTML. <a href="#refsHTML">[HTML]</a></p>

    <h3 id="extensibility"><span class="secno">2.2 </span>Extensibility</h3>

    <p>User agents, Working Groups, and other interested parties are
    <em>strongly encouraged</em> to discuss new features on a relevant public
    forum, preferably
    <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>. If this
    is for some reason not possible prefix the extension in some way. E.g. if
    company Foo wants to add a proprietary method <code>bar()</code> it could
    be named <code>fooBar()</code> to prevent clashes with a potential
    non-proprietary method <code>bar()</code>.</p>

    <h2 id="terminology"><span class="secno">3 </span>Terminology</h2>

    <p>The <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> interface provides asynchronous access to the result of an operation that is ongoing, has yet to start, or has completed, as defined in <a href="#refsDOM">[DOM]</a>.</p>

    <h2 id="interfaces"><span class="secno">4 </span>Interfaces</h2>
    <p class="note">This section normatively specifies the interfaces and the algorithms for the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> infrastructure and lifecycle management. Relevant explainer is followed on the subsequent sections: Bootstrapping, Upgrade, <code><a href="#fetchevent">FetchEvent</a></code> and Caching.</p>

    <h3 id="extensions-to-the-navigator-object"><span class="secno">4.1 </span>Extensions to the <code>Navigator</code> object</h3>
    <pre class="idl">partial interface <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#navigator-0">Navigator</a> {
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <a href="#serviceworker-navigator-registerserviceworker" title="serviceworker-navigator-registerserviceworker">registerServiceWorker</a>(DOMString <var>scriptURL</var>, optional <a href="#serviceworkerscopeoptions">ServiceWorkerScopeOptions</a> <var>options</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <span title="">unregisterServiceWorker</span>(<a href="#serviceworker-0">ServiceWorker</a> <var><a href="#serviceworker-0">serviceWorker</a></var>);
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onserviceworkerinstall</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onserviceworkerreplaced</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onserviceworkerreloadpage</span>;
};

dictionary <dfn id="serviceworkerscopeoptions" title="ServiceWorkerScopeOptions">ServiceWorkerScopeOptions</dfn> {
  DOMString <span title="">scope</span> = "/*";
};</pre>

    <p>When the <dfn id="serviceworker-navigator-registerserviceworker" title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker(scriptURL, options)</code></dfn> method is invoked, the user agent must run the following steps:</p>

    <ol>
      <li><p>Let <var>promise</var> be a newly-created <code><a class="external" href="http://w3c.github.io/dom/#promises">Promise</a></code> object.</li>
      <li><p>Return <var>promise</var> and run the remaining steps asynchronously.</li>
      <li><p>If the request violates a policy decision (e.g. if the user agent is configured to not allow the page to start service workers), run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception">DOMException</a> object whose type is "<a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#securityerror">SecurityError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      </li>
      <li><p><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#resolve-a-url" title="resolve a url">Resolve</a> the <var>scriptURL</var> argument.</li>
      <li><p>If this fails, run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception">DOMException</a> object whose type is "<a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#syntaxerror">SyntaxError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      </li>
      <li><p>Let <var>scriptURL</var> be the resulting <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#absolute-url">absolute URL</a> and <var>parsed scriptURL</var> be the resulting <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#parsed-url">parsed URL</a>.</li>
      <li><p>Let <var>options</var> be the value of the second argument, or null if the second argument was omitted.</li>
      <li><p>If the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#scheme">scheme</a> component of <var>parsed scriptURL</var> is not "<code>data</code>", and the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#origin">origin</a> of <var>scriptURL</var> is not the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#same-origin" title="same origin">same</a> as the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#origin">origin</a> specified by the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a>, run these substeps and abort these steps:</p>
        <ol>
          <li><p>Let <var>error</var> be a new <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception">DOMException</a> object whose type is "<a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#securityerror">SecurityError</a>".</li>
          <li><p>Reject <var>promise</var> with <var>error</var>.</li>
        </ol>
      <p class="note">Thus, scripts must either be external files with the same scheme, host, and port as the original page, or <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#data:-url" title="data protocol"><code>data:</code> URLs</a>. For example, and an <code>https:</code> page couldn't start workers using scripts with http: URLs.</li>
      <li><p>Let <var>docs</var> be the <a class="external" href="http://dev.w3.org/html5/workers/#list-of-relevant-document-objects-to-add" title="list of relevant document objects to add">list of relevant <code>Document</code> objects to add</a> given the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a>.</li>
      <li><p>Execute the following substeps atomically:</p>
        <ol>
          <li><p>Create a new <a href="#serviceworker-0">ServiceWorker</a> object, which will shortly be associated with a <a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a> object. Let this <a href="#serviceworker-0">ServiceWorker</a> object be <var>worker</var>.</li>
          <li><p>Create a new <a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a> object whose owner is the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a>. Let this be the <var>outside port</var>.</li>
          <li><p>Associate the <var>outside port</var> with <var>worker</var>.</li>
          <li><p>Let <var>worker global scope</var> be null.</li>
          <li><p>If there exists a <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object whose <a class="external" href="http://dev.w3.org/html5/workers/#dom-workerglobalscope-closing">closing</a> flag is false, whose <code><span>location</span></code> attribute represents an <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#absolute-url">absolute URL</a> that is exactly equal to <var>scriptURL</var>, run these substeps:</p>
            <ol>
              <li><p>If <var>options</var> is not null and the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object's <code><span>scope</span></code> attribute is not exactly equal to <var>scope</var> of <var>options</var>, set the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object's <code><span>scope</span></code> attribute to <var>scope</var> of <var>options</var>.</li>
              <li><p>If <var>options</var> is null and the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object's <code><span>scope</span></code> attribute is not the default scope, "<code>/*</code>", set the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object's <code><span>scope</span></code> attribute to "<code>/*</code>".</li>
              <li><p>Let <var>worker global scope</var> be that <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object.</li>
            </ol>
          </li>
          <li><p>If <var>worker global scope</var> is not null, but the user agent has been configured to disallow communication between the worker represented by the <var>worker global scope</var> and the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#script-0" title="script-0">scripts</a> whose <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#settings-object">settings object</a>s are the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a>, then set <var>worker global scope</var> to null.</li>
          <li><p>If <var>worker global scope</var> is not null, then run these steps:</p>
            <ol>
              <li><p>If <var>worker global scope</var>'s <code><a class="external" href="http://dev.w3.org/html5/workers/#dom-workerglobalscope-location">location</a></code> attribute represents an <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#absolute-url">absolute URL</a> that is not exactly equal to <var>scriptURL</var>, run these substeps and abort these steps:</p>
                <ol>
                  <li><p>Let <var>error</var> be a new <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#domexception">DOMException</a> object whose type is "<a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#urlmismatcherror">URLMismatchError</a>".</li>
                  <li><p>Reject <var>promise</var> with <var>error</var>.</li>
                </ol>
              </li>
              <li><p>Associate <var>worker</var> with <var>worker global scope</var>.</li>
              <li><p>Let <var>settings object</var> be the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#script-settings-object">script settings object</a> whose <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object">global object</a> is <var>worker global scope</var>.</li>
              <li><p>Create a new <a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a> object whose owner is <var>settings object</var>. Let this be <var>inside port</var>.</li>
              <li><p><a class="external" href="http://dev.w3.org/html5/postmsg/#entangle">Entangle</a> <var>outside port</var> and <var>inside port</var>.</li>
              <li><p>Create a <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#trusted-event">trusted event</a> that uses the <code><a class="external" href="http://dev.w3.org/html5/postmsg/#messageevent">MessageEvent</a></code> interface, with the name <code>install</code>, which does not bubble, is not cancelable, has no default action, has a <code><span>services</span></code> attribute whose value is initialized to an empty array, has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-data">data</a></code> attribute whose value is initialized to the empty string, has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-ports">ports</a></code> attribute whose value is initialized to a <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#read-only">read only</a> array containing only the newly created port, and has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-source">source</a></code> attribute whose value is initialized to the newly created port, and <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#queue-a-task">queue a task</a> to <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#dispatching">dispatch</a> the event at <var>worker global scope</var>.</li>
              <li><p><a class="external" href="http://dev.w3.org/html5/workers/#add-a-document-to-the-worker-s-documents" title="add-a-document-to-the-worker-s-documents">Add to <var>worker global scope</var>'s list of the worker's <code>Document</code>s</a> the <code><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/dom.html#document">Document</a></code> objects in <var>docs</var>.</li>
              <li><p>If the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object">global object</a> specified by the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a> is a <code><a class="external" href="http://dev.w3.org/html5/workers/#workerglobalscope">WorkerGlobalScope</a></code> object, add <var>worker global scope</var> to the list of <a class="external" href="http://dev.w3.org/html5/workers/#the-worker-s-workers" title="the-worker-s-workers">the worker's workers</a> of the <code><a class="external" href="http://dev.w3.org/html5/workers/#workerglobalscope">WorkerGlobalScope</a></code> object that is the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object">global object</a> specified by the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a> .</li>
              <li><p>Return <var>worker</var> and abort all these steps.</li>
            </ol>
          </li>
          <li><p>Create a new <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object. Let <var>worker global scope</var> be this new object.</p>
            <p class="critical">When there exists aother active service worker which covers the exactly same <code><span>scope</span></code> with different <code><span>scriptURL</span></code>, a new service worker is to be created by this algorithm. As the newly created worker would be effective from the next page load, that currently effective worker should not be terminated right away. An algorithm to sweep the unbound service workers should be added. Sweeping must not be conducted unless otherwise the list of <a class="external" href="http://dev.w3.org/html5/workers/#the-worker-s-documents" title="the-worker-s-documents">the worker's <code><span>Document</span></code>s</a> is empty. (See <a href="#last-registration-wins">Last-registration wins</a>.)</p>
          </li>
          <li><p><a class="external" href="http://dev.w3.org/html5/workers/#set-up-a-worker-script-settings-object">Set up a worker script settings object</a> with <var>worker global scope</var> and <var>scriptURL</var>, and let <var>settings object</var> be the result.</li>
          <li><p>Associate <var>worker</var> with <var>worker global scope</var>.</li>



          <li><p>If <var>options</var> is not null, set the <code><span>scope</span></code> attribute of <var>worker global scope</var> to <var>scope</var> of <var>options</var>; Otherwise, set the <code><span>scope</span></code> attribute of <var>worker global scope</var> to the default scope, "<code>/*</code>".</li>
          <li><p>Create a new <code><a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a></code> object whose <a class="external" href="http://dev.w3.org/html5/postmsg/#concept-port-owner">owner</a> is <var>settings object</var>. Let <var>inside port</var> be this new object.</li>
          <li><p><a class="external" href="http://dev.w3.org/html5/postmsg/#entangle">Entangle</a> <var>outside port</var> and <var>inside port</var>.</li>
        </ol>
      </li>
      <li><p>Let <var title="">serviceWorker</var> be <var>worker</var>.</li>
      <li><p>Resolve <var>promise</var> with <var title="">serviceWorker</var> and perform the remaining steps asynchronously.</li>
      <li><p>Create a <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#trusted-event">trusted event</a> that uses the <code><a class="external" href="http://dev.w3.org/html5/postmsg/#messageevent">MessageEvent</a></code> interface, with the name <code>install</code>, which does not bubble, is not cancelable, has no default action, has a <code><span>services</span></code> attribute whose value is initialized to an empty array, has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-data">data</a></code> attribute whose value is initialized to the empty string, has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-ports">ports</a></code> attribute whose value is initialized to a <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#read-only">read only</a> array containing only the newly created port, and has a <code><a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageevent-source">source</a></code> attribute whose value is initialized to the newly created port, and <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#queue-a-task">queue a task</a> to <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#dispatching">dispatch</a> the event at <var>worker global scope</var>.</li>
      <li><p><a class="external" href="http://dev.w3.org/html5/workers/#add-a-document-to-the-worker-s-documents" title="add-a-document-to-the-worker-s-documents">Add to <var>worker global scope</var>'s list of the worker's <code>Document</code>s</a> the <code><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/dom.html#document">Document</a></code> objects in <var>docs</var>.</li>
      <li><p>If the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object">global object</a> specified by the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a> is a <code><a class="external" href="http://dev.w3.org/html5/workers/#workerglobalscope">WorkerGlobalScope</a></code> object, add <var>worker global scope</var> to the list of <a class="external" href="http://dev.w3.org/html5/workers/#the-worker-s-workers" title="the-worker-s-workers">the worker's workers</a> of the <code><a class="external" href="http://dev.w3.org/html5/workers/#workerglobalscope">WorkerGlobalScope</a></code> object that is the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#global-object">global object</a> specified by the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#incumbent-settings-object">incumbent settings object</a> .</li>
      <li><p><a class="external" href="http://dev.w3.org/html5/workers/#run-a-worker">Run a worker</a> for the script with <a class="external" href="http://url.spec.whatwg.org/#url">URL</a> <var>scriptURL</var> and the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#script-settings-object">script settings object</a> <var>settings object</var>.</li>
    </ol>
    <p>The <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#task-source">task source</a> for the tasks mentioned above is the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#dom-manipulation-task-source" title="dom-manipulation-task-source">DOM manipulation task source</a>.</p>

    <p>The following are the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers">event handlers</a> (and their corresponding <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a>s) that must be supported, as <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute">event handler IDL attribute</a>s, by objects implementing the extended <code><span>Navigator</span></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" title="event handlers">event handler</a></th>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="handler-serviceworker-onserviceworkerinstall" title="handler-serviceworker-onserviceworkerinstall"><code>onserviceworkerinstall</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerinstall"><a href="#event-serviceworker-serviceworkerinstall">serviceworkerinstall</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onserviceworkerreplaced" title="handler-serviceworker-onserviceworkerreplaced"><code>onserviceworkerreplaced</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerreplaced"><a href="#event-serviceworker-serviceworkerreplaced">serviceworkerreplaced</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onserviceworkerreloadpage" title="handler-serviceworker-onserviceworkerreloadpage"><code>onserviceworkerreloadpage</code></dfn></td>
          <td><code title="event-serviceworker-serviceworkerreloadpage"><a href="#event-serviceworker-serviceworkerreloadpage">serviceworkerreloadpage</a></code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-serviceworker-interface"><span class="secno">4.2 </span>The <code><a href="#serviceworker-0">ServiceWorker</a></code> interface</h3>
    <pre class="idl">[NoInterfaceObject]
interface <dfn id="serviceworker-0">ServiceWorker</dfn> : <a class="external" href="http://w3c.github.io/dom/#eventtarget">EventTarget</a> {
  void <span title="">postMessage</span>(any <var>message</var>, optional sequence&lt;Transferable&gt; <var>transfer</var>);
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onmessage</span>;
};
<a href="#serviceworker-0">ServiceWorker</a> implements <a class="external" href="http://dev.w3.org/html5/workers/#abstractworker" title="abstractworker">AbstractWorker</a>;</pre>

    <p><code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> objects act as if they had an implicit <a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a> associated with them. This port is part of a channel that is set up when the worker is registered, but it is not exposed. It represents the <a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a> for communicating with the service worker. This object must never be garbage collected before the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> object.</p>

    <p>All messages received by that port must immediately be retargeted at the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> object.</p>

    <p>The <code>postMessage()</code> method on <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> objects must act as if, when invoked, it immediately invoked <a class="external" href="http://dev.w3.org/html5/postmsg/#dom-messageport-postmessage" title="dom-messageport-postmessage">the method of the same name</a> on the port, with the same arguments, and returned the same return value.</p>

    <p>The following are the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers">event handlers</a> (and their corresponding <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a>s) that must be supported, as <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute">event handler IDL attribute</a>s, by objects implementing the <code><a href="#serviceworker-0"><span>ServiceWorker</span></a></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" title="event handlers">event handler</a></th>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="handler-serviceworker-onmessage" title="handler-serviceworker-onmessage"><code>onmessage</code></dfn></td>
          <td><code title="event-serviceworker-message">message</code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-serviceworkerglobalscope-interface"><span class="secno">4.3 </span>The <code><a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a></code> interface</h3>
    <pre class="idl">[Global]
interface <dfn id="serviceworkerglobalscope">ServiceWorkerGlobalScope</dfn> : <a class="external" href="http://dev.w3.org/html5/workers/#workerglobalscope">WorkerGlobalScope</a> {
  getter <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy">WindowProxy</a>[] windows();
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <span title="">fetch</span>((<a href="#request">Request</a> or <a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or DOMString or any) <var><a href="#request">request</a></var>);
  [Unforgeable] readonly attribute DOMString scope;
          attribute <a href="#cachelist">CacheList</a> caches;
          attribute any version;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>oninstall</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onactivate</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onfetch</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onbeforeevicted</span>;
          attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#eventhandler">EventHandler</a> <span>onevicted</span>;
  // close() method inherited from WorkerGlobalScope is not exposed.
};</pre>

    <p>The <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> interface must only be <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#exposed-to-javascript">exposed to JavaScript</a> if the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#javascript-global-environment">JavaScript global environment</a> is a <span>service worker environment</span>.</p>

    <p class="note">Todo: the definition of the <span>service worker environment</span> should be placed in the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#processing-model-3">processing model</a> section of HTML specification.</p>

    <p>Service workers receive message ports through <code><span>install</span></code> events on their <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> object for each registration.</p>

    <dl class="domintro">
      <dt><code><var>this</var>.windows</code></dt>
      <dd>Returns the array of the the <code><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#window">Window</a></code> object's <code><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#browsing-context">browsing context</a></code>'s <code><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy">WindowProxy</a></code> object that the <a href="#serviceworkerglobalscope"><code>ServiceWorkerGlobalScope</code></a> is bound to.</dd>
      <dt><code><var>this</var>.fetch()</code></dt>
      <dd>Returns the <code>Promise</code> object that represents the <code><a href="#response">Response</a></code> object of the <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>ed resource.</dd>
      <dt><code><var>this</var>.scope</code></dt>
      <dd>Returns the <code>scope</code> string that the worker listens to.</dd>
      <dt><code><var>this</var>.caches</code></dt>
      <dd>Returns the current <code><a href="#cachelist">CacheList</a></code> object.</dd>
      <dt><code><var>this</var>.version</code></dt>
      <dd>Returns the version that has been set by the worker. It is <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#structured-clone">structured clone</a>able.</dd>
    </dl>

    <p class="note">The <code>version</code> attribute is used to communicate to newer versions what they are replaceing (see the <code>previousVersion</code> attribute of the <code><a href="#installevent">InstallEvent</a></code> interface.)</p>

    <p>The following are the <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers">event handlers</a> (and their corresponding <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a>s) that must be supported, as <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-idl-attribute">event handler IDL attribute</a>s, by objects implementing the <code><a href="#serviceworkerglobalscope"><span>ServiceWorkerGlobalScope</span></a></code> interface:</p>

    <table>
      <thead>
        <tr>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handlers" title="event handlers">event handler</a></th>
          <th><a class="external" href="http://www.w3.org/html/wg/drafts/html/master/webappapis.html#event-handler-event-type">event handler event type</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="handler-serviceworker-oninstall" title="handler-serviceworker-oninstall"><code>oninstall</code></dfn></td>
          <td><code title="event-serviceworker-install"><a href="#event-serviceworker-install">install</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onactivate" title="handler-serviceworker-onactivate"><code>onactivate</code></dfn></td>
          <td><code title="event-serviceworker-activate"><a href="#event-serviceworker-activate">activate</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onfetch" title="handler-serviceworker-onfetch"><code>onfetch</code></dfn></td>
          <td><code title="event-serviceworker-fetch"><a href="#event-serviceworker-fetch">fetch</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onbeforeevicted" title="handler-serviceworker-onbeforeevicted"><code>onbeforeevicted</code></dfn></td>
          <td><code title="event-serviceworker-beforeevicted"><a href="#event-serviceworker-beforeevicted">beforeevicted</a></code></td>
        </tr>
        <tr>
          <td><dfn id="handler-serviceworker-onevicted" title="handler-serviceworker-onevicted"><code>onevicted</code></dfn></td>
          <td><code title="event-serviceworker-evicted"><a href="#event-serviceworker-evicted">evicted</a></code></td>
        </tr>
      </tbody>
    </table>

    <h3 id="the-reloadpageevent-interface"><span class="secno">4.4 </span>The <code><a href="#reloadpageevent">ReloadPageEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="reloadpageevent">ReloadPageEvent</dfn> : <a class="external" href="http://w3c.github.io/dom/#event">Event</a> {
  void <span>waitUntil</span>(<a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> f);
};</pre>

    <h3 id="the-installevent-interface"><span class="secno">4.5 </span>The <code><a href="#installevent">InstallEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="installevent">InstallEvent</dfn> : <a href="#installphaseevent">InstallPhaseEvent</a> {
  void <span>replace</span>();
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <span>reloadAll</span>();
          attribute <a class="external" href="http://dev.w3.org/html5/postmsg/#messageport">MessagePort</a> previous;
          attribute DOMString[] services;
};</pre>

    <dl class="domintro">
      <dt><code><var>event</var>.replace()</code></dt>
      <dd>Ensures that the worker is used in place of existing workers for the currently controlled set of window instances.</dd>
    </dl>

    <h3 id="the-installphaseevent-interface"><span class="secno">4.6 </span>The <code><a href="#installphaseevent">InstallPhaseEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="installphaseevent">InstallPhaseEvent</dfn> : <a class="external" href="http://w3c.github.io/dom/#event">Event</a> {
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <span>waitUntil</span>(<a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <var>f</var>);
          attribute any previousVersion;
};</pre>

    <dl class="domintro">
      <dt><code><var>event</var>.waitUntil(<var>f</var>)</code></dt>
      <dd>Delays treating the installing worker until the argument <var>f</var> resolves successfully. This is primarily used to ensure that a service worker is not active until all of the "core" <code><a href="#cache">Cache</a></code>s it depends on are populated. It returns a newly-created <code><a class="external" href="http://w3c.github.io/dom/#promises">Promise</a></code> object.</dd>
    </dl>

    <h3 id="the-fetchevent-interface"><span class="secno">4.7 </span>The <code><a href="#fetchevent">FetchEvent</a></code> interface</h3>
    <pre class="idl">[Constructor]
interface <dfn id="fetchevent">FetchEvent</dfn> : <a class="external" href="http://w3c.github.io/dom/#event">Event</a> {
  void <span>respondWith</span>((<a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> or <a href="#response">Response</a>) <var>r</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> <span>forwardTo</span>((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) <var>url</var>);
  readonly attribute <a href="#request">Request</a> request;
  readonly attribute <a href="#requesttype">RequestType</a> type;
  readonly attribute <a class="external" href="http://www.w3.org/html/wg/drafts/html/master/browsers.html#windowproxy">WindowProxy</a> window;
  readonly attribute boolean isTopLevel;
  readonly attribute boolean isReload;
};

enum <dfn id="requesttype">RequestType</dfn> {
    "navigate",
    "fetch"
};</pre>

    <h3 id="the-beforecacheevictionevent-interface"><span class="secno">4.8 </span>The <code><a href="#beforecacheevictionevent">BeforeCacheEvictionEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="beforecacheevictionevent">BeforeCacheEvictionEvent</dfn> : <a class="external" href="http://w3c.github.io/dom/#event">Event</a> {
  // To be defined.
};</pre>

    <h3 id="the-cacheevictionevent-interface"><span class="secno">4.9 </span>The <code><a href="#cacheevictionevent">CacheEvictionEvent</a></code> interface</h3>
    <pre class="idl">interface <dfn id="cacheevictionevent">CacheEvictionEvent</dfn> : <a class="external" href="http://w3c.github.io/dom/#event">Event</a> {
  // To be defined.
};</pre>

    <h3 id="the-request-interface"><span class="secno">4.10 </span>The <code><a href="#request">Request</a></code> interface</h3>
    <pre class="idl">// <a href="#request">request</a>
[Constructor(optional <a href="#requestinit">RequestInit</a> init)]
interface <dfn id="request">Request</dfn> {
  readonly attribute unsigned long timeout;
  readonly attribute (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) url;
  readonly attribute DOMString encoding;
  readonly attribute ByteString method;
  readonly attribute (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) origin;
  readonly attribute <a href="#mode">Mode</a> mode;
  readonly attribute boolean synchronous;
  readonly attribute unsigned long redirectCount;
  readonly attribute boolean forcePreflight;
  readonly attribute boolean omitCredentials;
  readonly attribute (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) referrer;
  ByteString? <span>getHeader</span>(ByteString <var><a href="#header">header</a></var>);
          attribute sequence&lt;<a href="#header">Header</a>&gt; headers;
  readonly attribute any body;
};

dictionary <dfn id="requestinit">RequestInit</dfn> {
  unsigned long timeout;
  (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) url;
  DOMString encoding;
  ByteString method = "GET";
  boolean synchronous = false;
  unsigned long redirectCount = 0;
  boolean forcePreflight = false;
  boolean omitCredentials = false;
  (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) referrer;
  sequence&lt;<a href="#header">Header</a>&gt; headers;
  any body = null;
};

enum <dfn id="mode">Mode</dfn> {
  "same origin",
  "tainted x-origin",
  "CORS"
};

dictionary <dfn id="header">Header</dfn> {
  ByteString name;
  ByteString value;
};</pre>

    <h3 id="the-response-interface"><span class="secno">4.11 </span>The <code><a href="#response">Response</a></code> interface</h3>
    <pre class="idl">[Constructor]
interface <dfn id="response">Response</dfn> {
};</pre>

    <h3 id="the-sameoriginresponse-interface"><span class="secno">4.12 </span>The <code><a href="#sameoriginresponse">SameOriginResponse</a></code> interface</h3>
    <pre class="idl">[Constructor(optional <a href="#sameoriginresponseinit">SameOriginResponseInit</a> <var>responseInitDict</var>)]
interface <dfn id="sameoriginresponse">SameOriginResponse</dfn> : <a href="#response">Response</a> {
  void <span>setHeader</span>(ByteString <var>name</var>, ByteString <var>value</var>);
  ByteString? <span>getHeader</span>(ByteString <var><a href="#header">header</a></var>);
          attribute sequence&lt;<a href="#header">Header</a>&gt; headers;
          attribute unsigned short statusCode;
          attribute ByteString statusText;
          attribute DOMString encoding;
          attribute ByteString method;
          attribute any body;
};

dictionary <dfn id="sameoriginresponseinit">SameOriginResponseInit</dfn> {
  unsigned short statusCode = 200;
  ByteString statusText = "OK";
  DOMString encoding;
  ByteString method;
  sequence&lt;<a href="#header">Header</a>&gt; headers;
  any body;
};</pre>

    <h3 id="the-crossoriginresponse-interface"><span class="secno">4.13 </span>The <code><a href="#crossoriginresponse">CrossOriginResponse</a></code> interface</h3>
    <pre class="idl">interface <dfn id="crossoriginresponse">CrossOriginResponse</dfn> : <a href="#response">Response</a> {
};</pre>

    <h3 id="the-cache-interface"><span class="secno">4.14 </span>The <code><a href="#cache">Cache</a></code> interface</h3>
    <pre class="idl">[Constructor((URL or [EnsureUTF16] DOMString)... urls)]
interface <dfn id="cache">Cache</dfn> {
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> match((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) <var>name</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> add((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString)... <var>responses</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> addResponse((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) <var>url</var>, <a href="#response">Response</a> <var><a href="#response">response</a></var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> remove((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString)... <var>responses</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> update((<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString)... <var>urls</var>);
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> ready();
        attribute <a href="#asyncmap">AsyncMap</a> items;
};

[<a class="external" href="http://heycam.github.io/webidl/#MapClass">MapClass</a>(DOMString, <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a>)]
interface <dfn id="asyncmap">AsyncMap</dfn> {
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> items();
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> keys();
  <a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> values();
};</pre>

    <h3 id="the-cachelist-interface"><span class="secno">4.15 </span>The <code><a href="#cachelist">CacheList</a></code> interface</h3>
    <pre class="idl">[<a class="external" href="http://heycam.github.io/webidl/#MapClass">MapClass</a>(DOMString, <a href="#cache">Cache</a>)]
interface <dfn id="cachelist">CacheList</dfn> {
  (<a class="external" href="http://w3c.github.io/dom/#promises">Promise</a> or <a href="#response">Response</a>) match(DOMString <var>name</var>, (<a class="external" href="http://url.spec.whatwg.org/#url">URL</a> or [EnsureUTF16] DOMString) <var>url</var>);
};</pre>

    <h3 id="events"><span class="secno">4.16 </span>Events summary</h3>

    <p><em>This section is non-normative.</em></p>

    <p>The following events are dispatched on the extended <code>Navigator</code> object:</p>
    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when…</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="event-serviceworker-serviceworkerinstall" title="event-serviceworker-serviceworkerinstall"><code>serviceworkerinstall</code></dfn></td>
          <td><code>Event</code></td>
          <td>A new worker becomes in-waiting.</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-serviceworkerreplaced" title="event-serviceworker-serviceworkerreplaced"><code>serviceworkerreplaced</code></dfn></td>
          <td><code>Event</code></td>
          <td>A new worker takes over via <code><a href="#installevent">InstallEvent</a></code>'s <span>replace</span>() method.</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-serviceworkerreloadpage" title="event-serviceworker-serviceworkerreloadpage"><code>serviceworkerreloadpage</code></dfn></td>
          <td><code><a href="#reloadpageevent">ReloadPageEvent</a></code></td>
          <td>Restarting all <code><span>windows</span></code> with the new worker via <code><a href="#installevent">InstallEvent</a></code>'s <span>reloadAll</span>() method.</td>
        </tr>
      </tbody>
    </table>

    <p>The following events are dispatched on <code><a href="#serviceworkerglobalscope">ServiceWorkerGlobalScope</a></code> object:</p>
    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when…</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="event-serviceworker-install" title="event-serviceworker-install"><code>install</code></dfn></td>
          <td><code><a href="#installevent">InstallEvent</a></code></td>
          <td>A worker is downloaded and being setup to handle events (navigations, alerts, etc.)</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-activate" title="event-serviceworker-activate"><code>activate</code></dfn></td>
          <td><code><a href="#installphaseevent">InstallPhaseEvent</a></code></td>
          <td>A worker becomes the active event worker for a mapping</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-fetch" title="event-serviceworker-fetch"><code>fetch</code></dfn></td>
          <td><code><a href="#fetchevent">FetchEvent</a></code></td>
          <td>This worker is meant to decide the disposition of a request.</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-beforeevicted" title="event-serviceworker-beforeevicted"><code>beforeevicted</code></dfn></td>
          <td><code><a href="#beforecacheevictionevent">BeforeCacheEvictionEvent</a></code></td>
          <td>Before cache is about to be evicted.</td>
        </tr>
        <tr>
          <td><dfn id="event-serviceworker-evicted" title="event-serviceworker-evicted"><code>evicted</code></dfn></td>
          <td><code><a href="#cacheevictionevent">CacheEvictionEvent</a></code></td>
          <td>Cache is about to be evicted.</td>
        </tr>
      </tbody>
    </table>

    <h2 id="bootstrap-with-a-service-worker"><span class="secno">5 </span>Bootstrap with a service worker</h2>
    <p>A <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> MUST be installed either by invoking the <a href="#serviceworker-navigator-registerserviceworker" title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> method within web pages or by setting the member <em><a href="#serviceworker-0">serviceworker</a></em> of the manifest to be the URL of the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>.</p>

    <h3 id="the-registerserviceworker()-method"><span class="secno">5.1 </span>The <a href="#serviceworker-navigator-registerserviceworker" title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> method</h3>
    <p><a href="#concept-serviceworker" title="concept-serviceworker">Service worker</a>s MAY be installed by web pages. A user MUST visit a web page or web application for the process to start.</p>
    <div class="example">
      <pre title="Installation">// Document hosted at: http://videos.example.com/index.html
navigator.registerServiceWorker("/assets/v1/ctrl.js", { scope: "/*"}).then(
  function(serviceWorker) {
    console.log("success!");
    serviceWorker.postMessage("Howdy from your installing page.");
    // To use the serviceWorker immediately, you might call window.location.reload()
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });</pre>
    </div>

    <p>The example shows the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> hosted at <code>/assets/v1/ctrl.js</code> is installed by the web page hosted at <code>http://videos.example.com/index.html</code>.</p>
    <div class="example">
      <pre title="ServiceWorker script serving onfetch event">// Service worker script hosted at: /assets/v1/ctrl.js
this.version = 1;

var base = "http://videos.example.com";
var inventory = new URL("/services/inventory/data.json", base);

this.addEventListener("install", function(e) {
  // Tell the system that this service worker can handle fetch events.
  e.services = ["fetch"];
});

this.addEventListener("fetch", function(e) {
  var url = e.request.url;
  console.log(url);
  if (url.toString() == inventory.toString()) {
    e.respondWith(new SameOriginResponse({
      statusCode: 200,
      body: JSON.stringify({
        videos: { /* ... */ }
      })
    }));
  }
});
        </pre>
    </div>
    <p>
    Once the <code>ctrl.js</code> in the example is successfully installed, the "success!"" message will be sent to the console and, crucially, the next time the user visits <code>index.html</code> or any other page located at <code>http://videos.example.com/</code>, <code>ctrl.js</code> will be consulted about what to do and what content to load even if the device has no Internet connection. On pages that are <em>controlled</em> in this way, other resources (like images in the document body) are also requested first from <code>ctrl.js</code> before the normal browser cache is consulted for them.</p>

    <h3 id="the-member-serviceworker-of-the-manifest"><span class="secno">5.2 </span>The member <em><a href="#serviceworker-0"><code>serviceworker</code></a></em> of the manifest</h3>
    <p class="critical">This section remains unspecified as neither the architecture has been clarified nor has it been aligned with the standards track <a class="external" href="http://w3c.github.io/manifest/">manifest</a> specification.</p>

    <h3 id="controlled-and-uncontrolled-documents"><span class="secno">5.3 </span><em>Controlled</em> and <em>uncontrolled</em> documents</h3>
    <p>The first time <code>http://videos.example.com/index.html</code> is loaded, all the resources it requests will come from the network. That means that even if the browser runs the install snippet for <code>ctrl.js</code>, <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>es it, and finishes installing it before it begins <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>ing logo.png, the new <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> script would not be consulted about loading logo.png. This is down to the following rule of <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s:</p>
    <ul>
      <li>Documents live out their whole lives using the service worker they start with.</li>
    </ul>
    <p>This means that if a document starts life without a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>, even if one is installed for a matching bit of URL space, it would not suddenly get a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> later in life. Same goes for documents that are loaded with a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> which might later call <code>unregisterServiceWorker()</code>. Put another way, <a href="#serviceworker-navigator-registerserviceworker" title="serviceworker-navigator-registerserviceworker"><code>registerServiceWorker()</code></a> and <code>unregisterServiceWorker()</code> only affect the next document(s).</p>


    <h3 id="longest-prefix-matching"><span class="secno">5.4 </span>Longest-prefix matching</h3>
    <div class="example">
      <pre title="Longest-prefix matching [ex 1]">&lt;!DOCTYPE html&gt;
&lt;!-- http://www.example.com/foo.html --&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;script&gt;
      navigator.registerServiceWorker("/fooServiceWorker.js", { scope: "/foo*"});
    &lt;/script&gt;
  &lt;/head&gt;
&lt;/html&gt;</pre>
      <pre title="Longest-prefix matching [ex 2]">&lt;!DOCTYPE html&gt;
&lt;!-- http://www.example.com/foo/bar.html --&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;script&gt;
      navigator.registerServiceWorker("/foo/barServiceWorker.js", { scope: "/foo/bar*" });
    &lt;/script&gt;
  &lt;/head&gt;
&lt;/html&gt;</pre>
    </div>
    <p>To break what might otherwise be ties when matching URLs, navigations are mapped to <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s by longest-prefix-match. Note that the <code>*</code> can only occur at the end of a matching rule, so attempts to register <code>/foo/*/bar</code> or <code>*bar</code> will <a class="external" href="http://heycam.github.io/webidl/#dfn-throw">throw</a> exceptions. Similarly, registering a scope that includes a <code>"?"</code> or <code>"#"</code> will also <a class="external" href="http://heycam.github.io/webidl/#dfn-throw">throw</a>s exceptions.</p>
    <p>In the above example with registrations for <code>/foo*</code> and <code>/foo/bar*</code>, the following matches would be made when navigating to the following URLs under <code>http://www.example.com</code>:</p>
    <table border="1">
      <tr>
        <th>Scope (Pattern)</th>
        <th>URL</th>
      </tr>
      <tr>
        <td><code>/foo</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo?blarg</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/thinger.html</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foobar.html</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/other/thinger.html</code></td>
        <td><code>/fooServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar</code></td>
        <td><code>/foo/barServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/</code></td>
        <td><code>/foo/barServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/thinger.html</code></td>
        <td><code>/foo/barServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/foo/bar/baz/thinger.html</code></td>
        <td><code>/foo/barServiceWorker.js</code></td>
      </tr>
      <tr>
        <td><code>/index.html</code></td>
        <td><code>&lt;fallback to native&gt;</code></td>
      </tr>
      <tr>
        <td><code>/whatevs/index.html</code></td>
        <td><code>&lt;fallback to native&gt;</code></td>
      </tr>
    </table>
    <p><code>&lt;fallback to native&gt;</code> is the browser's built-in behavior for fetching resources - the thing the Fetch Service defers to when it does not handle a fetch with <code>e.respondWith()</code>.</p>
    <p class="note">If <code>e.respondWith()</code> is not called when handling a connection in <code>/foo/barServiceWorker.js</code>, it does not cascade to <code>/fooServiceWorker.js</code>, it falls back to the browser's built-in network behavior.</p>

    <h3 id="last-registration-wins"><span class="secno">5.5 </span><dfn>Last-registration wins</dfn></h3>
    <p>The registration system is also last-registration-wins. That means if two pages on <code>www.example.com</code> set a registration to control <code>/*</code>, the one a user visits second (assuming the first does not interfere) will be installed and over-write the previous registration.</p>

    <p>This makes sense because registration is the same as replacement. That is to say, if you have content that wants to replace the existing <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> with one at a different URL (perhaps a heavy-handed form of "new version"), registering the new URL is the way that you indicate that the old registration is no longer the preferred one.</p>

    <h3 id="cross-origin-limitation"><span class="secno">5.6 </span>Cross-origin limitation</h3>
    <p>One of the concerns that major applications hit is "how do I host things from a CDN?" By definition, these are servers in other places, often on other domains, that your content references. Can <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s be hosted on CDNs? No, this is not allowed since <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s can create the possibility of an XSS vulnerability, etc.</p>

    <p>But they can include resources (via <code>importScripts()</code>) that are.</p>

    <h2 id="lifecycle-of-a-service-worker"><span class="secno">6 </span>Lifecycle of a service worker</h2>
    <p>The browser might unceremoniously kill your <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> if it is idle, or even stop it mid-work and re-issue the request to a different instance of the worker. There are no guarantees about how long a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> will run. <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s should be written to avoid holding global state. This cannot be stressed enough: write your workers as though they will die after every request.</p>
    <p>Also remember that <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s are shared resources. A single worker might be servicing requests from multiple tabs or documents. Never assume that only one document is talking to a given <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>. If you care about where a request is coming from or going to, use the <code>.window</code> property of the <code>onfetch</code> event; but do not create state that you care about without serializing it somewhere like IndexedDB.</p>


    <h2 id="upgrade-with-a-new-version"><span class="secno">7 </span>Upgrade with a new version</h2>

    <h3 id="wait-for-restart"><span class="secno">7.1 </span>Wait-for-restart</h3>
    <p>The default policy is that this new tab will be controlled by v1. This is done to prevent the crazy-town scenario of multiple <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> versions running at the same time, possibly creating conflicts for IndexedDB schemas, content caches, and the like. Yes, there is a small window during <code>oninstall</code> when v2 will be running at the same time as v1, but they would not both be serving content. The advice then is: do not do irreversible things during oninstall. It is a good place to get a jump on populating caches (with unique names if the new content is reliant on the new <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>), but a bad place to do things like schema and model upgrades for your application.</p>

    <p>The alternative scenario is one in which the new version of your <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> is discovered and installed and no documents are running against v1. This could happen because:</p>

    <ul>
      <li>v1 was installed by a page that was loaded "naked", but which was never reloaded so as to start under the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>.</li>
      <li>The browser fetched an update of it is own volition. It is allowed to do that!</li>
      <li>Between the time <code>oninstall</code> started for the v2 <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> and when <code>waitUntil()</code> was finally satisfied, all of the application's windows were closed.</li>
    </ul>

    <p>When this happens, v2 instantly becomes the active <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>, so the next time you navigate to a URL controlled by the registration, v2 would get first crack at it.</p>

    <p>Indeed, v2 will become the active <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> just as soon as all v1 documents are closed.</p>

    <p>When v2 does become the active <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>, another event - <code>onactivate</code> - is sent to v2. This happens before any fetches are dispatched. This is the ideal time to upgrade database schemas and the like, but be careful not to do too much work. Applications will be blocked from loading while <code>onactivate</code> is being serviced (including any extensions asked for via <code>e.waitUntil()</code>, which is also available to <code>onactivate</code> handlers). Treat <code>onactivate</code> as a time to stake your claim as the new version but beware doing more than that lest you make your app unavailable!</p>

    <h3 id="replacement"><span class="secno">7.2 </span>Replacement</h3>
    <p>An alternative policy is available for the daring: a new <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> can choose to cut-in and replace an existing one. And before you ask, yes, this does break the first rule. But not much.</p>

    <p>To replace an existing <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>, use the <code>.replace()</code> method of the <code>oninstall</code> event during the event dispatch. In fact, you can even call <code>.replace()</code> on the very first install of a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>, which will now make your <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> the proud owner of all windows/tabs whose URLs match the registration origin and scope including the page that registered it.</p>

    <p>Here is an example: we'll compare the versions to ensure that they are not so far apart that stepping in would break things; leaving the old <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> in place if the version skew is too great and taking over if it is a difference our new version is confident it can handle. Consider v1.3 vs. v1.0:</p>

    <div class="example">
      <pre title="Replacement">// caching.js
this.version = 1.3;

var assetBase = "/assets/v" + parseInt(this.version) + "/";
var shellCacheName = "shell-v" + parseInt(this.version);
var contentCacheName = "content";

this.addEventListener("install", function(e) {
  e.services = ["fetch"];

  // Create a cache of resources. Begins the process of fetching them.
  var shellResources = new Cache(
    assetBase + "/base.css",
    assetBase + "/app.js",
    assetBase + "/logo.png",
    assetBase + "/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  this.caches.set(shellCacheName, shellResources);

  // Prepare an additional cache that we can add items to later
  if (!this.caches.has(contentCacheName)) {
    this.caches.set(contentCacheName, new Cache());
  }

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());

  // If and only if we're less than one major version ahead, cut-in and start
  // serving resources.
  if (parseInt(e.previousVersion) == parseInt(this.version)) {
    // Note: replacement won't happen until the Promise passed to
    // e.waitUntil resolves
    e.replace();
  }
});

// ...onfetch, etc...</pre>
    </div>
    <p>The <code>previousVersion</code> field of the event is filled in using a structured clone of the global version property set by the last execution of the previous <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>. It is a good idea both to always set a version and, sort of obviously, not to make it something that can't be cloned or which varies.</p>

    <p>What of the old <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>? What happens to it?</p>

    <p>The replacing <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> can send a message to the old <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> in <code>oninstalled</code> using <code>e.previous.postMessage()</code>. This can blossom into a bi-directional discussion if both sides have registered <code>onmessage</code> handlers, but that is out of the scope of this document for now.</p>

    <h2 id="offline-first-resource-handling"><span class="secno">8 </span>Offline-first resource handling</h2>

    <h3 id="fetchevent-handling"><span class="secno">8.1 </span><code><a href="#fetchevent">FetchEvent</a></code> handling</h3>
    <p><a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s, once installed, can choose to handle resource loading. Before going to the network to <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a> a document that matches the service worker's scope, the worker is consulted, including when <a class="external" href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>ing the document payload itself.

    Here is an example of a <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> that only handles a single resource (<code>/services/inventory/data.json</code>) but which logs out requests for all resources it is consulted for:</p>

    <div class="example">
      <pre title="onfetch handling in a service worker">// hosted at: /assets/v1/ctrl.js
this.version = 1;

var base = "http://videos.example.com";
var inventory = new URL("/services/inventory/data.json", base);

this.addEventListener("install", function(e) {
  // Tell the system that this service worker can handle fetch events.
  e.services = ["fetch"];
});

this.addEventListener("fetch", function(e) {
  var url = e.request.url;
  console.log(url);
  if (url.toString() == inventory.toString()) {
    e.respondWith(new SameOriginResponse({
      statusCode: 200,
      body: JSON.stringify({
        videos: { /* ... */ }
      })
    }));
  }
});</pre>
    </div>
    <p>The contents of all but the inventory will be handled by the normal browser resource fetching system because the onfetch event handler did not call <code>respondWith</code> when invoked with their requests. The first time the app is loaded (before the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> is installed), <code>data.json</code> will also be fetched from the network. Thereafter it will be computed by the <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a> instead. The important thing to remember here is that normal resource loading is the fallback behavior for fetch events.</p>
    <p>When combined with access to IndexedDB and a new form of <code><a href="#cache">Cache</a></code>, the ability to respond with arbitrary content is incredibly powerful. Since installed <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s are invoked even when offline, <a href="#concept-serviceworker" title="concept-serviceworker">service worker</a>s enable apps that are "offline by default" once installed.</p>

    <h3 id="navigation-vs-fetch"><span class="secno">8.2 </span>Navigation vs Fetch</h3>
    <p>Description</p>

    <h3 id="fallback-rule"><span class="secno">8.3 </span>Fallback rule</h3>
    <p>Description</p>

    <h3 id="redirects"><span class="secno">8.4 </span>Redirects</h3>
    <p>Description</p>

    <h3 id="cross-origin-resources"><span class="secno">8.5 </span>Cross-origin resources</h3>
    <p>Description</p>

    <h2 id="caching"><span class="secno">9 </span>Caching</h2>
    <div class="example">
      <pre title="Cache control in service worker script">// Service worker script hosted at: /assets/v1/caching.js
this.version = 1;

var base = "http://videos.example.com";
this.addEventListener("install", function(e) {
  e.services = ["fetch"];

  // Create a cache of resources. Begins the process of fetching them.
  // URLs are relative to the service worker
  var shellResources = new Cache(
    base + "/assets/v1/base.css",
    base + "/assets/v1/app.js",
    base + "/assets/v1/logo.png",
    base + "/assets/v1/intro_video.webm",
  );

  // Add Cache to the global so it can be used later during onfetch
  this.caches.set("shell-v1", shellResources);

  // The coast is only clear when all the resources are ready.
  e.waitUntil(shellResources.ready());
});</pre>
    </div>
    <h2 id="future-extension"><span class="secno">10 </span>Future extension</h2>
    <p class="critical">Need to address the requirements from SysApps WG use cases and more. Currently, TaskScheduler and notification would be the scope of this work. Security sensitive features will be considered as V2.</p>

    <h2 class="no-num" id="references">References</h2>
    <div id="anolis-references"><dl><dt id="refsDOM">[DOM]
<dd><cite><a href="http://w3c.github.io/dom/">DOM</a></cite>, Anne van Kesteren, Aryeh Gregor, Ms2ger et al.. W3C.

<dt id="refsECMASCRIPT">[ECMASCRIPT]
<dd><cite><a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ECMAScript Language Specification</a></cite>. ECMA.

<dt id="refsHTML">[HTML]
<dd><cite><a href="http://www.w3.org/html/wg/drafts/html/master/">HTML</a></cite>, Robin Berjon, Steve Faulkner, Travis Leithead et al.. W3C.

<dt id="refsHTTP">[HTTP]
<dd><cite><a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a></cite>, Roy Fielding, James Gettys, Jeffrey Mogul et al.. IETF.

<dt id="refsRFC2119">[RFC2119]
<dd><cite><a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a></cite>, Scott Bradner. IETF.

<dt id="refsURL">[URL]
<dd><cite><a href="http://url.spec.whatwg.org/">URL Standard</a></cite>, Anne van Kesteren. WHATWG.

<dt id="refsWEBIDL">[WEBIDL]
<dd><cite><a href="http://dev.w3.org/2006/webapi/WebIDL/">Web IDL</a></cite>, Cameron McCormack. W3C.

</dl></div>

    <h2 class="no-num" id="acknowledgments">Acknowledgments</h2>

    <p>The editors would like to thank
    Jake ("B.J.") Archibald,
    David Barrett-Kahn,
    Andrew Betts,
    Greg Billock,
    Aaron Boodman,
    Darin Fisher,
    Alec Flett,
    Anne van Kesteren,
    Anssi Kostiainen,
    Dominique Hazael-Massieux,
    Dave Herman,
    Michael Nordman,
    Soledad Penadés,
    Michael Sanford,
    Jonas Sicking,
    Chris Wilson,
    Ivan Žužak
    for their contributions to this specification.</p>

    <p>Thanks also to all those who have helped to improve this specification
    by sending suggestions and corrections. (Please, keep bugging us with your
    issues!)</p>
  

